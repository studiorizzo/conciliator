<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SESPRESSO Conciliator v4</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
        }
        
        .app-header {
            background: linear-gradient(135deg, #366092 0%, #2d4f7a 100%);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 1.5rem 2rem;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.3);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-size: 22px;
            font-weight: 700;
            color: white;
            letter-spacing: -0.5px;
        }
        
        .version {
            font-size: 12px;
            color: rgba(255,255,255,0.7);
            font-weight: 500;
        }
        
        .container {
            max-width: 1400px;
            margin: 20px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            display: none;
        }
        
        .main-content {
            padding: 0;
        }
        
        .welcome-screen {
            min-height: calc(100vh - 120px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px 40px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
        }
        
        @media (max-width: 768px) {
            .welcome-screen {
                padding: 40px 20px;
            }
        }
        
        .welcome-content {
            max-width: 1000px;
            text-align: center;
            width: 100%;
        }
        
        .welcome-content h1 {
            font-size: 48px;
            color: #366092;
            margin-bottom: 20px;
            font-weight: 700;
            line-height: 1.2;
        }
        
        @media (max-width: 768px) {
            .welcome-content h1 {
                font-size: 32px;
            }
        }
        
        @media (max-width: 480px) {
            .welcome-content h1 {
                font-size: 24px;
            }
        }
        
        .welcome-content p {
            font-size: 18px;
            color: #666;
            margin-bottom: 40px;
            line-height: 1.6;
        }
        
        @media (max-width: 768px) {
            .welcome-content p {
                font-size: 16px;
            }
        }
        
        .instructions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            margin-top: 50px;
        }
        
        @media (max-width: 768px) {
            .instructions {
                grid-template-columns: 1fr;
            }
        }
        
        .instruction-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .instruction-card:hover {
            transform: translateY(-5px);
        }
        
        .instruction-card .icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .instruction-card h3 {
            color: #366092;
            margin-bottom: 10px;
            font-size: 20px;
        }
        
        .instruction-card p {
            font-size: 14px;
            color: #666;
            margin: 0;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s ease, visibility 0.15s ease;
        }
        
        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-content {
            background: white;
            padding: 40px 60px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #366092;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-content h3 {
            color: #366092;
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .loading-content p {
            color: #666;
            font-size: 16px;
        }
        
        .upload-section {
            display: none;
        }
        
        .dropzone {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
        }
        
        .dropzone:hover {
            border-color: #366092;
            background: #f0f2ff;
        }
        
        .dropzone.active {
            background: #e8ebff;
            border-color: #366092;
        }
        
        .dropzone.uploaded {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .dropzone.uploaded p {
            display: none;
        }
        
        .dropzone.uploaded .file-info {
            display: block;
            font-size: 15px;
            font-weight: 600;
            color: #155724;
            text-align: center;
            margin-top: 10px;
            background: transparent;
            padding: 10px;
            border-radius: 8px;
        }
        
        .dropzone h3 {
            color: #366092;
            margin-bottom: 10px;
            font-size: 20px;
        }
        
        .dropzone p {
            color: #666;
            font-size: 14px;
        }
        
        .file-info {
            margin-top: 15px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            font-size: 14px;
            color: #333;
            display: none;
        }
        
        .config-fab {
            position: fixed;
            bottom: 110px;
            right: 30px;
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #366092, #2d4f7a);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(54, 96, 146, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }
        
        .config-fab.visible {
            display: flex;
        }
        
        .config-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 32px rgba(54, 96, 146, 0.5);
        }
        
        .config-fab.active {
            transform: scale(0.9);
            background: #2d4f7a;
            opacity: 0;
            pointer-events: none;
        }
        
        .config-fab svg {
            width: 28px;
            height: 28px;
            fill: white;
            transition: transform 0.3s;
        }
        
        .config-fab.active svg {
            transform: rotate(180deg);
        }
        
        .config-fab.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .upload-fab {
            position: fixed;
            bottom: 190px;
            right: 30px;
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(255, 107, 53, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }
        
        .upload-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 32px rgba(255, 107, 53, 0.5);
        }
        
        .upload-fab.active {
            transform: scale(0.9);
            opacity: 0;
            pointer-events: none;
        }
        
        .upload-fab.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .upload-fab svg {
            width: 28px;
            height: 28px;
            fill: white;
        }
        
        .download-fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #28a745, #20903d);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(40, 167, 69, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }
        
        .download-fab.visible {
            display: flex;
        }
        
        .download-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 32px rgba(40, 167, 69, 0.5);
        }
        
        .download-fab svg {
            width: 28px;
            height: 28px;
            fill: white;
        }
        
        .download-fab.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .upload-sidebar {
            position: fixed;
            top: 0;
            right: -450px;
            width: 450px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.15);
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 999;
            display: flex;
            flex-direction: column;
        }
        
        .upload-sidebar.open {
            right: 0;
        }
        
        .config-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.15);
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 999;
            display: flex;
            flex-direction: column;
        }
        
        .config-sidebar.open {
            right: 0;
        }
        
        .config-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s;
            z-index: 998;
        }
        
        .config-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid #e5e5e5;
            background: #fafafa;
            position: relative;
        }
        
        .sidebar-header h2 {
            font-size: 20px;
            font-weight: 700;
            color: #366092;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .sidebar-header p {
            font-size: 13px;
            color: #666;
            margin-top: 4px;
        }
        
        .close-btn {
            position: absolute;
            top: 24px;
            right: 24px;
            width: 36px;
            height: 36px;
            border: none;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: #666;
        }
        
        .close-btn:hover {
            background: #f0f0f0;
            color: #1a1a1a;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }
        
        .param-section {
            margin-bottom: 32px;
        }
        
        .param-section:last-child {
            margin-bottom: 0;
        }
        
        .section-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #999;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title::before {
            content: '';
            width: 3px;
            height: 12px;
            background: #366092;
            border-radius: 2px;
        }
        
        .param-item {
            margin-bottom: 24px;
        }
        
        .param-item:last-child {
            margin-bottom: 0;
        }
        
        .param-label {
            font-size: 14px;
            font-weight: 600;
            color: #2d4f7a;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .param-value {
            font-size: 18px;
            font-weight: 700;
            color: #366092;
        }
        
        .slider-container {
            position: relative;
        }
        
        .slider-track {
            height: 8px;
            background: #e5e5e5;
            border-radius: 4px;
            position: relative;
            cursor: pointer;
        }
        
        .slider-fill {
            height: 100%;
            background: linear-gradient(135deg, #366092, #2d4f7a);
            border-radius: 4px;
            position: relative;
            transition: width 0.1s ease-out;
        }
        
        .slider-thumb {
            width: 20px;
            height: 20px;
            background: white;
            border: 3px solid #366092;
            border-radius: 50%;
            position: absolute;
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: grab;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .slider-thumb:hover {
            transform: translateY(-50%) scale(1.15);
            box-shadow: 0 3px 12px rgba(54, 96, 146, 0.3);
        }
        
        .slider-thumb:active {
            cursor: grabbing;
        }
        
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .tag {
            padding: 8px 16px;
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        
        .tag:hover {
            background: #e8f0ff;
            border-color: #366092;
        }
        
        .tag.selected {
            background: #366092;
            color: white;
            border-color: #366092;
        }
        
        .commission-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .commission-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #f8f8f8;
            border-radius: 8px;
        }
        
        .commission-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #366092;
        }
        
        .commission-item label {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            color: #2d4f7a;
        }
        
        .commission-input {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .commission-input input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .commission-input input:focus {
            border-color: #366092;
        }
        
        .commission-input button {
            padding: 10px 16px;
            background: #366092;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .commission-input button:hover {
            background: #2d4f7a;
        }
        
        .sidebar-footer {
            padding: 20px 24px;
            border-top: 1px solid #e5e5e5;
            background: #fafafa;
        }
        
        .btn-concilia {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #366092, #2d4f7a);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(54, 96, 146, 0.3);
        }
        
        .btn-concilia:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(54, 96, 146, 0.4);
        }
        
        .btn-concilia:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-reload {
            width: 48px;
            height: 48px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            color: #666;
        }
        
        .btn-reload:hover {
            background: #f8f8f8;
            border-color: #366092;
            color: #366092;
        }
        
        .btn-reload.highlighted {
            animation: pulse-reload 2s infinite;
            border-color: #366092;
            box-shadow: 0 0 0 3px rgba(54, 96, 146, 0.1);
        }
        
        @keyframes pulse-reload {
            0%, 100% {
                box-shadow: 0 0 0 3px rgba(54, 96, 146, 0.1);
            }
            50% {
                box-shadow: 0 0 0 6px rgba(54, 96, 146, 0.2);
            }
        }
        
        .config-section {
            display: none;
        }
        
        .dropdown-button input[type="range"] {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 6px;
        }
        
        .dropdown-button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f5f5f5;
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #366092;
            border-radius: 8px;
            margin-top: 4px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .dropdown-content.show {
            display: block;
        }
        
        .dropdown-item {
            padding: 10px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .dropdown-item:hover {
            background: #f0f2ff;
        }
        
        .dropdown-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .dropdown-item.add-new {
            border-bottom: 1px solid #ddd;
            background: #f8f9fa;
            font-weight: 600;
            color: #366092;
        }
        
        .dropdown-item.add-new:hover {
            background: #e9ecef;
        }
        
        .add-commission-input {
            display: none;
            padding: 10px 12px;
            border-bottom: 1px solid #ddd;
        }
        
        .add-commission-input.show {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .add-commission-input input {
            flex: 1;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .add-commission-input button {
            padding: 6px 12px;
            background: #366092;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .add-commission-input button:hover {
            background: #2d4f7a;
        }
        
        .config-item input,
        .config-item select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }
        
        .config-item select[multiple] {
            min-height: 120px;
        }
        
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        
        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .button-container {
            text-align: center;
            margin: 40px 0;
        }
        
        .progress-container {
            display: none;
            margin: 30px 0;
        }
        
        .progress-bar {
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            width: 0%;
        }
        
        .results-section {
            display: none;
        }
        
        .summary {
            background: linear-gradient(135deg, #f0f2ff 0%, #fef3ff 100%);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .summary h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        
        .summary-grid {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        
        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            flex: 1;
            min-width: 180px;
        }
        
        .summary-card h3 {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .summary-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .summary-card .percentage {
            font-size: 1.2em;
            color: #10b981;
            margin-left: 10px;
        }
        
        /* TABS STILE FILE 2 */
        .tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .tab:hover {
            color: #366092;
        }
        
        .tab.active {
            color: #366092;
            border-bottom-color: #366092;
        }
        
        .tab-alert {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #dc3545;
            color: white;
            font-size: 14px;
            font-weight: bold;
            margin-left: 4px;
            animation: pulse-alert 2s infinite;
        }
        
        @keyframes pulse-alert {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* TABS E FILTRI LAYOUT */
        .tabs-and-filters {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            margin-bottom: 0;
        }
        
        .tabs-underline {
            height: 2px;
            background: #e0e0e0;
            margin-bottom: 20px;
        }
        
        .filters-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* BUTTON RESET ESTERNO */
        .btn-reset-filters-external {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            color: #999;
            cursor: pointer;
            transition: all 0.2s;
            padding: 0;
        }
        
        .btn-reset-filters-external:hover {
            border-color: #366092;
            color: #366092;
            background: #f0f2ff;
        }
        
        .btn-reset-filters-external.active {
            border-color: #ff6b35;
            color: #ff6b35;
            background: #fff5f2;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }
        
        .btn-reset-filters-external.active:hover {
            background: #ffe5dc;
        }
        
        /* FILTRI DROPDOWN */
        .filters-dropdown {
            position: relative;
        }
        
        .filters-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            height: 36px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            color: #666;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .filters-toggle:hover {
            border-color: #366092;
            color: #366092;
            background: #f0f2ff;
        }
        
        .filters-toggle.active {
            border-color: #366092;
            color: #366092;
            background: #f0f2ff;
        }
        
        .filters-toggle.has-filters {
            border-color: #366092;
            color: #366092;
            background: #e8f0ff;
            font-weight: 700;
        }
        
        .filters-toggle .arrow {
            transition: transform 0.2s;
        }
        
        .filters-toggle.active .arrow {
            transform: rotate(180deg);
        }
        
        .filters-menu {
            position: absolute;
            top: 0;
            right: calc(100% + 8px);
            min-width: 400px;
            background: white;
            border: 2px solid #366092;
            border-radius: 12px;
            box-shadow: -4px 4px 20px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 100;
            overflow: hidden;
        }
        
        .filters-menu.show {
            display: flex;
            gap: 0;
        }
        
        .filters-section {
            flex: 1;
            padding: 16px;
            border-right: 1px solid #e0e4ff;
        }
        
        .filters-section:last-of-type {
            border-right: none;
        }
        
        .filters-section-title {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            color: #366092;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }
        
        .filter-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 4px;
            cursor: pointer;
            transition: background 0.2s;
            border-radius: 6px;
        }
        
        .filter-option:hover {
            background: #f8f9ff;
        }
        
        .filter-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #366092;
        }
        
        .filter-option span {
            font-size: 14px;
            color: #333;
            user-select: none;
        }
        
        .filters-controls.hidden {
            display: none;
        }
        
        /* BADGE STATO */
        .badge-stato {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-conciliato {
            background: #d1e7ff;
            color: #0066cc;
        }
        
        .badge-non-conciliato {
            background: #ffe5d1;
            color: #cc6600;
        }
        
        /* COLORI IMPORTI */
        .importo-uscita {
            color: #8b0000;
            font-weight: 600;
        }
        
        .importo-entrata {
            color: #006400;
            font-weight: 600;
        }
        
        .importo-dare {
            color: #006400;
            font-weight: 600;
        }
        
        .importo-avere {
            color: #8b0000;
            font-weight: 600;
        }
        
        /* ROW HIDDEN PER FILTRI */
        tr.filter-hidden {
            display: none;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        thead {
            background: #366092;
            color: white;
        }
        
        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #e0e4ff;
        }
        
        tbody tr:hover {
            background: #f8f9ff;
        }
        
        tfoot {
            background: #f0f4ff;
            border-top: 3px solid #366092;
        }
        
        tfoot td {
            padding: 14px 12px;
            border-bottom: none;
        }
        
        .totals-row {
            font-weight: 700;
            font-size: 15px;
        }
        
        /* NASCONDERE COLONNE IN BASE AI FILTRI */
        .hide-column-uscite .col-uscite {
            display: none;
        }
        
        .hide-column-entrate .col-entrate {
            display: none;
        }
        
        .hide-column-dare .col-dare {
            display: none;
        }
        
        .hide-column-avere .col-avere {
            display: none;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
            animation: slideIn 0.3s;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        #alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }
        
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        input[type="file"] {
            display: none;
        }
        
        /* Spostamento colonne - Estratto Conto */
        #tab-estratto-conto table th:nth-child(8),
        #tab-estratto-conto table td:nth-child(8) {
            position: relative;
            left: -20px;
        }
        
        #tab-estratto-conto table th:nth-child(9),
        #tab-estratto-conto table td:nth-child(9) {
            position: relative;
            left: -20px;
        }
        
        /* Spostamento colonna - Mastrino */
        #tab-mastrino table th:nth-child(9),
        #tab-mastrino table td:nth-child(9) {
            position: relative;
            left: -20px;
        }
    </style>
</head>
<body>
    <div class="app-header">
        <div class="header-content">
            <div class="logo">SESPRESSO Conciliator <span class="version">v4</span></div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>Conciliazione Bancaria SESPRESSO</h1>
            <p>Sistema avanzato di conciliazione estratto conto e mastrino - v3.0</p>
        </div>
        
        <div class="main-content">
            <!-- Alert Container -->
            <div id="alert-container"></div>
            
            <!-- Welcome Screen -->
            <div class="welcome-screen" id="welcome-screen">
                <div class="welcome-content">
                    <h1>Smartmatic. Pronti? Click!</h1>
                    <p>Conciliazione automatica tra estratto conto e mastrino contabile</p>
                    
                    <div class="instructions">
                        <div class="instruction-card">
                            <div class="icon">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="48" height="48" fill="#ff6b35">
                                    <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v3H5z"/>
                                </svg>
                            </div>
                            <h3>1. Carica i File</h3>
                            <p>Clicca sull'icona arancione per caricare estratto conto e mastrino, seleziona i trimestri e avvia la conciliazione</p>
                        </div>
                        <div class="instruction-card">
                            <div class="icon">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="48" height="48" fill="#366092">
                                    <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94L14.4 2.81a.488.488 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                                </svg>
                            </div>
                            <h3>2. Personalizza</h3>
                            <p>Dopo la prima conciliazione, usa l'icona blu per modificare le tolleranze e ri-conciliare con parametri diversi</p>
                        </div>
                        <div class="instruction-card">
                            <div class="icon">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="48" height="48" fill="#28a745">
                                    <path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z"/>
                                </svg>
                            </div>
                            <h3>3. Scarica Risultati</h3>
                            <p>Visualizza i risultati a schermo e clicca sull'icona verde per scaricare l'Excel completo con tutte le conciliazioni</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Upload Section (hidden initially) -->
            <div class="upload-section">
                <div class="dropzone" id="dropzone-estratto">
                    <h3>Estratto Conto</h3>
                    <p>Trascina qui il file Excel oppure clicca per selezionarlo</p>
                    <input type="file" id="file-estratto" accept=".xlsx,.xls">
                    <div class="file-info" id="info-estratto"></div>
                </div>
                
                <div class="dropzone" id="dropzone-mastrino">
                    <h3>Mastrino Contabile</h3>
                    <p>Trascina qui il file Excel oppure clicca per selezionarlo</p>
                    <input type="file" id="file-mastrino" accept=".xlsx,.xls">
                    <div class="file-info" id="info-mastrino"></div>
                </div>
            </div>
            
            <!-- Progress -->
            <div class="progress-container" id="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill">0%</div>
                </div>
            </div>
            
            <!-- Results -->
            <div class="results-section" id="results-section">
                <div class="summary">
                    <h2>Riepilogo Conciliazione</h2>
                    <div class="summary-grid" id="summaryGrid"></div>
                </div>
                
                <div class="tabs-and-filters">
                    <div class="tabs">
                        <button class="tab active" data-tab="estratto-conto">Estratto Conto</button>
                        <button class="tab" data-tab="mastrino">
                            Mastrino
                            <span id="mastrino-alert" class="tab-alert" style="display: none;" title="Discordanza tra movimenti bancari e mastrino non conciliati"></span>
                        </button>
                        <button class="tab" data-tab="commissioni">Commissioni da registrare</button>
                    </div>
                    
                    <div class="filters-controls" id="filters-controls">
                        <div class="filters-dropdown" id="filters-dropdown">
                            <button class="filters-toggle" id="filters-toggle" onclick="toggleFilters()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/>
                                </svg>
                                Filtri
                                <svg class="arrow" width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M7 10l5 5 5-5z"/>
                                </svg>
                            </button>
                            <div class="filters-menu" id="filters-menu">
                                <div class="filters-section">
                                    <div class="filters-section-title">Tipo Movimento</div>
                                    <label class="filter-option">
                                        <input type="radio" name="tipo-filter" value="all" checked onchange="applyFilters()">
                                        <span>Tutti</span>
                                    </label>
                                    <label class="filter-option">
                                        <input type="radio" name="tipo-filter" value="entrate-dare" onchange="applyFilters()">
                                        <span>Entrate / Dare</span>
                                    </label>
                                    <label class="filter-option">
                                        <input type="radio" name="tipo-filter" value="uscite-avere" onchange="applyFilters()">
                                        <span>Uscite / Avere</span>
                                    </label>
                                </div>
                                <div class="filters-section">
                                    <div class="filters-section-title">Stato</div>
                                    <label class="filter-option">
                                        <input type="radio" name="stato-filter" value="all" checked onchange="applyFilters()">
                                        <span>Tutti</span>
                                    </label>
                                    <label class="filter-option">
                                        <input type="radio" name="stato-filter" value="conciliati" onchange="applyFilters()">
                                        <span>Conciliati</span>
                                    </label>
                                    <label class="filter-option">
                                        <input type="radio" name="stato-filter" value="non-conciliati" onchange="applyFilters()">
                                        <span>Non Conciliati</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <button class="btn-reset-filters-external" id="btn-reset-filters" onclick="resetFilters()" title="Reset filtri">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="tab-content active" id="tab-estratto-conto">
                    <div class="table-container">
                        <table id="table-estratto-conto"></table>
                    </div>
                </div>
                
                <div class="tab-content" id="tab-mastrino">
                    <div class="table-container">
                        <table id="table-mastrino"></table>
                    </div>
                </div>
                
                <div class="tab-content" id="tab-commissioni">
                    <div class="table-container">
                        <table id="table-commissioni"></table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3 id="loading-title">Conciliazione in corso...</h3>
            <p id="loading-subtitle">Analisi dei movimenti e ricerca corrispondenze</p>
        </div>
    </div>
    
    <div class="upload-fab" id="upload-fab">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v3H5z"/>
        </svg>
    </div>
    
    <div class="config-fab" id="fab">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94L14.4 2.81a.488.488 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
        </svg>
    </div>
    
    <div class="download-fab" id="download-fab">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z"/>
        </svg>
    </div>
    
    <div class="config-overlay" id="overlay"></div>
    
    <div class="upload-sidebar" id="upload-sidebar">
        <div class="sidebar-header">
            <h2>Upload</h2>
            <p>Carica i file necessari per la conciliazione</p>
            <button class="close-btn" onclick="closeUploadSidebar()">âœ•</button>
        </div>
        
        <div class="sidebar-content">
            <div class="param-section">
                <div class="section-title">File Richiesti</div>
                
                <div class="param-item">
                    <div class="param-label" style="display: block; margin-bottom: 12px;">
                        <span>Estratto Conto</span>
                    </div>
                    <div class="dropzone" id="dropzone-estratto-sidebar" style="margin: 0;">
                        <h3>Estratto Conto</h3>
                        <p>Trascina qui il file Excel oppure clicca per selezionarlo</p>
                        <input type="file" id="file-estratto-sidebar" accept=".xlsx,.xls" style="display: none;">
                        <div class="file-info" id="info-estratto-sidebar"></div>
                    </div>
                </div>
                
                <div class="param-item">
                    <div class="param-label" style="display: block; margin-bottom: 12px;">
                        <span>Mastrino Contabile</span>
                    </div>
                    <div class="dropzone" id="dropzone-mastrino-sidebar" style="margin: 0;">
                        <h3>Mastrino Contabile</h3>
                        <p>Trascina qui il file Excel oppure clicca per selezionarlo</p>
                        <input type="file" id="file-mastrino-sidebar" accept=".xlsx,.xls" style="display: none;">
                        <div class="file-info" id="info-mastrino-sidebar"></div>
                    </div>
                </div>
            </div>
            
            <div class="param-section">
                <div class="section-title">Periodi</div>
                <div class="tags-container">
                    <div class="tag" data-value="Q1" onclick="toggleTag(this)">TRIM 1</div>
                    <div class="tag" data-value="Q2" onclick="toggleTag(this)">TRIM 2</div>
                    <div class="tag" data-value="Q3" onclick="toggleTag(this)">TRIM 3</div>
                    <div class="tag" data-value="Q4" onclick="toggleTag(this)">TRIM 4</div>
                </div>
            </div>
        </div>
        
        <div class="sidebar-footer">
            <div style="display: flex; gap: 12px;">
                <button class="btn-concilia" id="btn-concilia-upload" onclick="conciliaFromUpload()">
                    ðŸš€ Concilia
                </button>
                <button class="btn-reload" id="btn-reload-upload" onclick="resetPagina()" title="Ricomincia da capo">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    
    <div class="config-sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>Configurazione</h2>
            <p>Personalizza i parametri di conciliazione</p>
            <button class="close-btn" onclick="closeSidebar()">âœ•</button>
        </div>
        
        <div class="sidebar-content">
            <div class="param-section">
                <div class="section-title">Tolleranze</div>
                
                <div class="param-item">
                    <div class="param-label">
                        <span>Max Movimenti</span>
                        <span class="param-value" id="val-movimenti">1</span>
                    </div>
                    <div class="slider-container">
                        <div class="slider-track" id="track-movimenti" onclick="setSliderValue(event, 'movimenti', 1, 20)">
                            <div class="slider-fill" id="fill-movimenti" style="width: 0%;">
                                <div class="slider-thumb"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="param-item">
                    <div class="param-label">
                        <span>Tolleranza Importo</span>
                        <span class="param-value" id="val-importo">â‚¬ 0.01</span>
                    </div>
                    <div class="slider-container">
                        <div class="slider-track" id="track-importo" onclick="setSliderValue(event, 'importo', 0.01, 1)">
                            <div class="slider-fill" id="fill-importo" style="width: 0%;">
                                <div class="slider-thumb"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="param-item">
                    <div class="param-label">
                        <span>Tolleranza Giorni</span>
                        <span class="param-value" id="val-giorni">0</span>
                    </div>
                    <div class="slider-container">
                        <div class="slider-track" id="track-giorni" onclick="setSliderValue(event, 'giorni', 0, 15)">
                            <div class="slider-fill" id="fill-giorni" style="width: 0%;">
                                <div class="slider-thumb"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="param-section">
                <div class="section-title">Commissioni Ammesse</div>
                
                <div class="commission-list" id="commission-list">
                    <div class="commission-item">
                        <input type="checkbox" id="comm-075" checked onchange="updateCommissioniConfig()">
                        <label for="comm-075">â‚¬ 0.75</label>
                    </div>
                    <div class="commission-item">
                        <input type="checkbox" id="comm-175" checked onchange="updateCommissioniConfig()">
                        <label for="comm-175">â‚¬ 1.75</label>
                    </div>
                </div>
                
                <div class="commission-input">
                    <input type="number" id="new-commission" placeholder="Es. 2.50" step="0.01" min="0">
                    <button onclick="addCommissionSidebar()">+ Aggiungi</button>
                </div>
            </div>
        </div>
        
        <div class="sidebar-footer">
            <div style="display: flex; gap: 12px;">
                <button class="btn-concilia" id="btn-concilia-sidebar" onclick="applicaConfigESalva()">
                    ðŸš€ Concilia
                </button>
                <button class="btn-reload" onclick="resetConfig()" title="Ripristina configurazione predefinita">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // === GESTIONE SIDEBAR UPLOAD ===
        const uploadFab = document.getElementById('upload-fab');
        const uploadSidebar = document.getElementById('upload-sidebar');
        const downloadFab = document.getElementById('download-fab');
        const welcomeScreen = document.getElementById('welcome-screen');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        function mostraLoading(title = 'Conciliazione in corso...', subtitle = 'Analisi dei movimenti e ricerca corrispondenze') {
            const loadingTitle = document.getElementById('loading-title');
            const loadingSubtitle = document.getElementById('loading-subtitle');
            if (loadingTitle) loadingTitle.textContent = title;
            if (loadingSubtitle) loadingSubtitle.textContent = subtitle;
            loadingOverlay.classList.add('active');
        }
        
        function nascondiLoading() {
            loadingOverlay.classList.remove('active');
        }
        
        uploadFab.addEventListener('click', () => {
            const isOpen = uploadSidebar.classList.contains('open');
            if (isOpen) {
                closeUploadSidebar();
            } else {
                openUploadSidebar();
            }
        });
        
        function openUploadSidebar() {
            closeConfigSidebar();
            uploadSidebar.classList.add('open');
            overlay.classList.add('active');
            uploadFab.classList.add('active');
            // Nascondi altre icone
            fab.classList.add('hidden');
            if (downloadFab.classList.contains('visible')) {
                downloadFab.classList.add('hidden');
            }
        }
        
        function closeUploadSidebar() {
            uploadSidebar.classList.remove('open');
            overlay.classList.remove('active');
            uploadFab.classList.remove('active');
            // Mostra altre icone
            fab.classList.remove('hidden');
            if (downloadFab.classList.contains('visible')) {
                downloadFab.classList.remove('hidden');
            }
        }
        
        downloadFab.addEventListener('click', () => {
            if (risultati) {
                generaExcel();
            }
        });
        
        function mostraDownloadFab() {
            downloadFab.classList.add('visible');
        }
        
        function nascondiDownloadFab() {
            downloadFab.classList.remove('visible');
        }
        
        function conciliaFromUpload() {
            if (!estrattoConto || !mastrino) {
                alert('âš ï¸ Devi prima caricare entrambi i file!');
                return;
            }
            
            const periodi = getPeriodi();
            if (periodi.length === 0) {
                alert('âš ï¸ Seleziona almeno un periodo!');
                return;
            }
            
            updateCommissioniConfig();
            closeUploadSidebar();
            
            // Nascondi welcome screen
            if (welcomeScreen) {
                welcomeScreen.style.display = 'none';
            }
            
            avviaConciliazioneAutomatica();
            
            // Disabilita il pulsante Concilia ed evidenzia il pulsante Reload dopo la prima conciliazione
            setTimeout(() => {
                const btnConcilia = document.getElementById('btn-concilia-upload');
                const btnReload = document.getElementById('btn-reload-upload');
                
                if (btnConcilia && hasConciliatoUnaVolta) {
                    btnConcilia.disabled = true;
                    btnConcilia.style.opacity = '0.4';
                    btnConcilia.style.cursor = 'not-allowed';
                    btnConcilia.title = 'Prima conciliazione completata. Usa â†» per ricominciare oppure vai in âš™ï¸ per riconciliare con nuovi parametri.';
                    
                    // Evidenzia il pulsante reload
                    if (btnReload) {
                        btnReload.classList.add('highlighted');
                        btnReload.title = 'Clicca qui per ricaricare e ricominciare da capo';
                    }
                }
            }, 1000); // Aspetta che la conciliazione sia completata
        }
        
        function mostraConfigFab() {
            fab.classList.add('visible');
        }
        
        function resetPagina() {
            if (confirm('âš ï¸ Sei sicuro di voler ricaricare la pagina? Tutti i dati andranno persi.')) {
                location.reload();
            }
        }
        
        
        // === GESTIONE SIDEBAR CONFIGURAZIONE ===
        const fab = document.getElementById('fab');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        
        let sliderValues = {
            movimenti: 1,
            importo: 0.01,
            giorni: 0
        };
        
        fab.addEventListener('click', () => {
            const isOpen = sidebar.classList.contains('open');
            if (isOpen) {
                closeConfigSidebar();
            } else {
                openConfigSidebar();
            }
        });
        
        overlay.addEventListener('click', () => {
            closeConfigSidebar();
            closeUploadSidebar();
        });
        
        function openConfigSidebar() {
            closeUploadSidebar();
            sidebar.classList.add('open');
            overlay.classList.add('active');
            fab.classList.add('active');
            // Nascondi altre icone
            uploadFab.classList.add('hidden');
            if (downloadFab.classList.contains('visible')) {
                downloadFab.classList.add('hidden');
            }
        }
        
        function closeConfigSidebar() {
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
            fab.classList.remove('active');
            // Mostra altre icone
            uploadFab.classList.remove('hidden');
            if (downloadFab.classList.contains('visible')) {
                downloadFab.classList.remove('hidden');
            }
        }
        
        function closeSidebar() {
            closeConfigSidebar();
        }
        
        function toggleTag(tag) {
            tag.classList.toggle('selected');
        }
        
        let isDragging = false;
        let currentSlider = null;
        
        function setSliderValue(event, id, min, max) {
            const track = event.currentTarget;
            const rect = track.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const percentage = Math.max(0, Math.min(100, (x / rect.width) * 100));
            updateSlider(id, percentage, min, max);
        }
        
        document.querySelectorAll('.slider-thumb').forEach(thumb => {
            thumb.addEventListener('mousedown', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                isDragging = true;
                const fill = this.parentElement;
                const track = fill.parentElement;
                const sliderId = fill.id.replace('fill-', '');
                
                let min, max;
                if (sliderId === 'movimenti') {
                    min = 1; max = 20;
                } else if (sliderId === 'importo') {
                    min = 0.01; max = 1;
                } else if (sliderId === 'giorni') {
                    min = 0; max = 15;
                }
                
                currentSlider = { id: sliderId, track: track, min: min, max: max };
                document.body.style.cursor = 'grabbing';
            });
        });
        
        document.addEventListener('mousemove', function(e) {
            if (!isDragging || !currentSlider) return;
            
            const rect = currentSlider.track.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const percentage = Math.max(0, Math.min(100, (x / rect.width) * 100));
            updateSlider(currentSlider.id, percentage, currentSlider.min, currentSlider.max);
        });
        
        document.addEventListener('mouseup', function() {
            if (isDragging) {
                isDragging = false;
                currentSlider = null;
                document.body.style.cursor = '';
            }
        });
        
        function updateSlider(id, percentage, min, max) {
            const fill = document.getElementById(`fill-${id}`);
            const valueEl = document.getElementById(`val-${id}`);
            
            fill.style.width = percentage + '%';
            
            const value = min + (max - min) * (percentage / 100);
            let displayValue;
            
            if (id === 'movimenti' || id === 'giorni') {
                displayValue = Math.round(value);
                sliderValues[id] = displayValue;
            } else {
                displayValue = value.toFixed(2);
                sliderValues[id] = parseFloat(displayValue);
            }
            
            if (id === 'importo') {
                valueEl.textContent = 'â‚¬ ' + displayValue;
            } else {
                valueEl.textContent = displayValue;
            }
        }
        
        function addCommissionSidebar() {
            const input = document.getElementById('new-commission');
            const value = parseFloat(input.value);
            
            if (!value || value <= 0) {
                alert('Inserisci un valore valido maggiore di 0');
                return;
            }
            
            const list = document.getElementById('commission-list');
            const existingItems = Array.from(list.querySelectorAll('.commission-item'));
            
            for (let item of existingItems) {
                const existingValue = parseFloat(item.querySelector('label').textContent.replace('â‚¬ ', ''));
                if (existingValue === value) {
                    alert('Commissione giÃ  presente');
                    return;
                }
            }
            
            const item = document.createElement('div');
            item.className = 'commission-item';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = 'comm-' + value.toString().replace('.', '');
            checkbox.checked = true;
            checkbox.onchange = updateCommissioniConfig;
            
            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.textContent = 'â‚¬ ' + value.toFixed(2);
            
            item.appendChild(checkbox);
            item.appendChild(label);
            
            let inserted = false;
            for (let i = 0; i < existingItems.length; i++) {
                const existingValue = parseFloat(existingItems[i].querySelector('label').textContent.replace('â‚¬ ', ''));
                if (value < existingValue) {
                    list.insertBefore(item, existingItems[i]);
                    inserted = true;
                    break;
                }
            }
            
            if (!inserted) {
                list.appendChild(item);
            }
            
            input.value = '';
        }
        
        function updateCommissioniConfig() {
            COMMISSIONI_AMMESSE = Array.from(document.querySelectorAll('#commission-list input:checked')).map(c => {
                const text = c.nextElementSibling.textContent.replace('â‚¬ ', '');
                return parseFloat(text);
            });
        }
        
        function resetConfig() {
            // NON resettiamo i periodi perchÃ© vengono impostati solo dalla sidebar upload
            
            updateSlider('movimenti', 0, 1, 20);
            updateSlider('importo', 0, 0.01, 1);
            updateSlider('giorni', 0, 0, 15);
            
            document.querySelectorAll('#commission-list input').forEach(c => {
                if (c.id === 'comm-075' || c.id === 'comm-175') {
                    c.checked = true;
                } else {
                    c.closest('.commission-item').remove();
                }
            });
            
            updateCommissioniConfig();
        }
        
        function applicaConfigESalva() {
            if (!estrattoConto || !mastrino) {
                alert('âš ï¸ Devi prima caricare entrambi i file!');
                return;
            }
            
            const periodi = getPeriodi();
            if (periodi.length === 0) {
                alert('âš ï¸ Seleziona almeno un periodo!');
                return;
            }
            
            updateCommissioniConfig();
            closeConfigSidebar();
            avviaConciliazioneAutomatica();
        }
        
        // === STATO GLOBALE ===
        let estrattoConto = null;
        let mastrino = null;
        let risultati = null;
        let annoRiferimento = null;
        
        let COMMISSIONI_AMMESSE = [0.75, 1.75]; // Modificabile dall'utente
        
        // === TABELLA COMMISSIONI DA REGISTRARE ===
        let commissioniDaRegistrare = [];
        
        function aggiungiCommissioneDaRegistrare(importo, dataBanca, progBanca, descrizioneBanca, importoBanca) {
            // Evita duplicati
            const esiste = commissioniDaRegistrare.find(c => 
                Math.abs(c.importo - importo) <= 0.01 &&
                c.prog_banca === progBanca
            );
            
            if (!esiste) {
                commissioniDaRegistrare.push({
                    prog_banca: progBanca,
                    data_banca: dataBanca,
                    descrizione: descrizioneBanca || '',
                    importo: importo,
                    importo_banca: importoBanca
                });
                console.log(`   ðŸ“ Registrata commissione â‚¬${formatImportoItaliano(importo)} per ${progBanca}`);
            }
        }
        
        // Helper per determinare se un match Ã¨ "sicuro" (da non rimettere in discussione)
        function isMatchSicuro(mov3, mov3, importo1, importo2, config, tolleranzaGiorni) {
            // Match sicuro se:
            // 1. Data esatta (stesso giorno, tolleranza giorni = 0)
            // 2. Importo con tolleranza <= 0.01
            // 3. Match 1-a-1 (non combinazioni)
            const dataEsatta = tolleranzaGiorni === 0 && 
                               mov3.data && mov3.data && 
                               mov3.data.getTime() === mov3.data.getTime();
            
            const diffImporto = Math.round(Math.abs(importo1 - importo2) * 100) / 100;
            const importoEsatto = diffImporto <= 0.01;
            
            return dataEsatta && importoEsatto;
        }
        
        console.log('ðŸš€ SESPRESSO Conciliator v4 - Inizializzazione');
        
        // === UTILITY FUNCTIONS ===
        
        function parseImportoItaliano(value) {
            if (value === null || value === undefined) return null;
            if (typeof value === 'string' && value.trim() === '') return null;
            if (typeof value === 'number' && !isNaN(value)) return value;
            
            let str = value.toString().trim();
            if (str === '') return null;
            
            str = str.replace(/\s/g, '');
            
            // Formato italiano completo: 1.234,56
            if (str.includes('.') && str.includes(',')) {
                str = str.replace(/\./g, '').replace(',', '.');
            }
            // Solo virgola: 1234,56
            else if (str.includes(',') && !str.includes('.')) {
                str = str.replace(',', '.');
            }
            // Solo punto ambiguo: 1.234
            else if (str.includes('.')) {
                const parts = str.split('.');
                if (parts.length === 2 && parts[1].length === 3) {
                    str = str.replace('.', '');
                }
            }
            
            const result = parseFloat(str);
            return isNaN(result) ? null : result;
        }
        
        function formatImportoItaliano(value) {
            if (value === null || value === undefined) return '';
            return value.toLocaleString('it-IT', { 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            });
        }
        
        function parseDataEsplicita(dataStr, annoDefault) {
            if (!dataStr) return null;
            
            try {
                // Caso 1: Ãˆ giÃ  una Date
                if (dataStr instanceof Date) {
                    return isNaN(dataStr.getTime()) ? null : dataStr;
                }
                
                // Caso 2: Ãˆ un numero Excel (data seriale)
                if (typeof dataStr === 'number') {
                    const date = XLSX.SSF.parse_date_code(dataStr);
                    return new Date(date.y, date.m - 1, date.d);
                }
                
                const str = dataStr.toString().trim();
                
                // Caso 3: Formato "GG/MM" (estratto conto - senza anno)
                if (str.includes('/')) {
                    const parts = str.split('/');
                    if (parts.length === 2) {
                        const giorno = parseInt(parts[0]);
                        const mese = parseInt(parts[1]);
                        return new Date(annoDefault || new Date().getFullYear(), mese - 1, giorno);
                    } else if (parts.length === 3) {
                        const giorno = parseInt(parts[0]);
                        const mese = parseInt(parts[1]);
                        const anno = parseInt(parts[2]);
                        return new Date(anno, mese - 1, giorno);
                    }
                }
                // Caso 4: Formato ISO "AAAA-MM-GG" (mastrino)
                else if (str.includes('-')) {
                    return new Date(str);
                }
                
                return null;
            } catch (e) {
                console.error('âŒ Errore parsing data:', dataStr, e);
                return null;
            }
        }
        
        function estraiAnno(valutaStr) {
            if (!valutaStr) return null;
            
            try {
                if (valutaStr instanceof Date) {
                    return valutaStr.getFullYear();
                }
                
                // Numero Excel
                if (typeof valutaStr === 'number') {
                    const date = XLSX.SSF.parse_date_code(valutaStr);
                    return date.y;
                }
                
                const str = valutaStr.toString().trim();
                if (str.includes('/')) {
                    const parts = str.split('/');
                    if (parts.length === 3) {
                        return parseInt(parts[2]);
                    } else if (parts.length === 2) {
                        // "31/12" - uso anno corrente o 2024
                        return new Date().getFullYear();
                    }
                }
                
                return null;
            } catch (e) {
                console.error('âŒ Errore estrazione anno:', valutaStr, e);
                return null;
            }
        }
        
        function formatData(date) {
            if (!date) return '';
            const g = date.getDate().toString().padStart(2, '0');
            const m = (date.getMonth() + 1).toString().padStart(2, '0');
            const a = date.getFullYear();
            return `${g}/${m}/${a}`;
        }
        
        function isInTrimestre(data, trimestre, anno) {
            if (!data || !anno) return false;
            
            const ranges = {
                'Q1': { start: new Date(anno, 0, 1), end: new Date(anno, 2, 31) },
                'Q2': { start: new Date(anno, 3, 1), end: new Date(anno, 5, 30) },
                'Q3': { start: new Date(anno, 6, 1), end: new Date(anno, 8, 30) },
                'Q4': { start: new Date(anno, 9, 1), end: new Date(anno, 11, 31) }
            };
            
            const range = ranges[trimestre];
            return data >= range.start && data <= range.end;
        }
        
        function isCommissioneAmmessa(importo, tolleranza = 0.01) {
            // Arrotonda la differenza per evitare errori floating point
            return COMMISSIONI_AMMESSE.some(comm => {
                const diff = Math.round(Math.abs(importo - comm) * 100) / 100;
                return diff <= tolleranza;
            });
        }
        
        // === FILE HANDLING ===
        
        function setupDropzone(dropzoneId, inputId, infoId, tipo) {
            const dropzone = document.getElementById(dropzoneId);
            const input = document.getElementById(inputId);
            const info = document.getElementById(infoId);
            
            dropzone.addEventListener('click', () => input.click());
            
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('active');
            });
            
            dropzone.addEventListener('dragleave', () => {
                dropzone.classList.remove('active');
            });
            
            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('active');
                const file = e.dataTransfer.files[0];
                if (file) handleFile(file, tipo, dropzone, info);
            });
            
            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) handleFile(file, tipo, dropzone, info);
            });
        }
        
        function handleFile(file, tipo, dropzone, infoEl) {
            const inizioOverlay = Date.now();
            
            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                showAlert('âŒ Formato file non valido. Usa file Excel (.xlsx o .xls)', 'error');
                return;
            }
            
            // Mostra loading IMMEDIATAMENTE quando il file viene selezionato
            const tipoNome = tipo === 'estratto' ? 'Estratto Conto' : 'Mastrino Contabile';
            mostraLoading(`Lettura ${tipoNome} in corso...`, `Lettura del file ${file.name}`);
            
            // Separiamo fisicamente overlay e lettura del file
            // L'overlay appare subito, POI inizia la lettura del file
            setTimeout(() => {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        if (tipo === 'estratto') {
                            estrattoConto = parseEstrattoConto(workbook);
                            commissioniDaRegistrare = [];  // Reset tabella commissioni
                            infoEl.textContent = `âœ“ ${file.name} - ${estrattoConto.length} movimenti caricati`;
                        } else {
                            mastrino = parseMastrino(workbook);
                            commissioniDaRegistrare = [];  // Reset tabella commissioni
                            infoEl.textContent = `âœ“ ${file.name} - ${mastrino.length} movimenti caricati`;
                        }
                        
                        infoEl.style.display = 'block';
                        dropzone.classList.add('uploaded');
                        
                        // DELAY MINIMO GARANTITO: L'overlay rimane visibile almeno 800ms
                        const tempoTrascorso = Date.now() - inizioOverlay;
                        const delayMinimo = 800; // millisecondi
                        const ritardoNecessario = Math.max(0, delayMinimo - tempoTrascorso);
                        
                        setTimeout(() => {
                            nascondiLoading();
                            checkReady();
                            showAlert('âœ… File caricato con successo!', 'success');
                        }, ritardoNecessario);
                        
                    } catch (error) {
                        console.error('âŒ Errore parsing file:', error);
                        nascondiLoading();
                        showAlert('âŒ Errore nel parsing del file: ' + error.message, 'error');
                    }
                };
                
                // Inizia la lettura del file DOPO che l'overlay Ã¨ stato renderizzato
                reader.readAsArrayBuffer(file);
            }, 20); // 20ms sono sufficienti per garantire il repaint dell'overlay
        }
        
        function parseEstrattoConto(workbook) {
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(sheet);
            
            console.log('ðŸ“Š Parsing estratto conto...');
            console.log('   Righe totali:', json.length);
            
            // Trova anno di riferimento dalla prima riga con Valuta
            if (!annoRiferimento) {
                for (let row of json) {
                    if (row.Valuta) {
                        annoRiferimento = estraiAnno(row.Valuta);
                        console.log('ðŸ“… Anno riferimento estratto:', annoRiferimento);
                        break;
                    }
                }
            }
            
            // Filtra saldo iniziale e finale
            const movimenti = json.filter(row => {
                const desc = (row['Descrizione operazione'] || '').toString().toLowerCase();
                const isSaldo = desc.includes('saldo iniziale') || desc.includes('saldo finale');
                const hasData = row.Data && row.Data !== '';
                return !isSaldo && hasData;
            });
            
            console.log('   Movimenti validi (esclusi saldi):', movimenti.length);
            
            // Applica progressivi
            let progCounter = 1;
            const parsed = movimenti.map((row) => {
                const prog = `E${progCounter++}`;
                const dataStr = row.Data ? row.Data.toString() : '';
                const dataValutaStr = row.Valuta ? row.Valuta.toString() : '';
                const data = parseDataEsplicita(dataStr, annoRiferimento);
                const entrate = parseImportoItaliano(row.Entrate);
                const uscite = parseImportoItaliano(row.Uscite);
                
                return {
                    prog: prog,
                    data_str_originale: dataStr,
                    valuta_str_originale: dataValutaStr,
                    data: data,
                    descrizione: row['Descrizione operazione'] || '',
                    entrate: entrate,
                    uscite: uscite,
                    conciliato: false,
                    mastrino_progs: '',
                    banca_progs: '',
                    num_movimenti_mastrino: 0,
                    num_movimenti_banca: 0,
                    commissione_mastrino: 0,
                    commissione_calcolata: 0
                };
            });
            
            console.log('   Entrate:', parsed.filter(p => p.entrate !== null).length);
            console.log('   Uscite:', parsed.filter(p => p.uscite !== null).length);
            console.log('   Con data valida:', parsed.filter(p => p.data !== null).length);
            
            return parsed;
        }
        
        function parseMastrino(workbook) {
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(sheet);
            
            console.log('ðŸ“Š Parsing mastrino...');
            console.log('   Righe totali:', json.length);
            
            // Filtra righe valide
            const movimenti = json.filter(row => {
                return row.DataReg && (row.Dare || row.Avere);
            });
            
            console.log('   Movimenti validi:', movimenti.length);
            
            // Applica progressivi
            let progCounter = 1;
            const parsed = movimenti.map((row) => {
                const prog = `M${progCounter++}`;
                const dataReg = parseDataEsplicita(row.DataReg, annoRiferimento);
                const dataDoc = parseDataEsplicita(row.DataDoc, annoRiferimento);
                const dare = parseImportoItaliano(row.Dare);
                const avere = parseImportoItaliano(row.Avere);
                const saldo = parseImportoItaliano(row.Saldo);
                
                // Costruisci descrizione completa
                let descrizioneCompleta = [
                    row.DesCausale,
                    row.Des1Causale,
                    row.Des2Causale,
                    row.Des3Causale
                ].filter(x => x).join(' ');
                
                return {
                    prog: prog,
                    data_reg_str_originale: row.DataReg ? row.DataReg.toString() : '',
                    data: dataReg,
                    data_doc: dataDoc,
                    num_doc: row.NumDoc,
                    ndoc_orig: row.NdocOrig,
                    cod_causale: row.CodCausale,
                    descrizione: descrizioneCompleta,
                    dare: dare,
                    avere: avere,
                    saldo: saldo,
                    conciliato: false,
                    banca_prog: '',
                    tipo: dare ? 'dare' : 'avere'
                };
            });
            
            console.log('  DARE:', parsed.filter(p => p.dare !== null).length);
            console.log('  AVERE:', parsed.filter(p => p.avere !== null).length);
            console.log('  Con data valida:', parsed.filter(p => p.data !== null).length);
            
            return parsed;
        }
        
        function checkReady() {
            // Non piÃ¹ necessario - button concilia Ã¨ nella sidebar
        }
        
        function showAlert(message, type = 'success') {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            
            setTimeout(() => alert.remove(), 5000);
        }
        
        // === ALGORITMO CONCILIAZIONE ===
        
        function* combinations(arr, k) {
            if (k === 0) {
                yield [];
                return;
            }
            if (arr.length < k) return;
            
            for (let i = 0; i <= arr.length - k; i++) {
                const first = arr[i];
                const rest = arr.slice(i + 1);
                for (const combo of combinations(rest, k - 1)) {
                    yield [first, ...combo];
                }
            }
        }
        
        function trovaCombinazioni(movimenti, target, dataTarget, campoImporto, config, tolleranzaGiorni = 0) {
            const validi = movimenti.filter(m => {
                if (m.conciliato || !m.data || !dataTarget) return false;
                
                const diffGiorni = Math.abs((m.data.getTime() - dataTarget.getTime()) / (1000 * 60 * 60 * 24));
                return diffGiorni <= tolleranzaGiorni;
            });
            
            if (validi.length === 0) return null;
            
            for (let n = 1; n <= Math.min(validi.length, config.maxMovimenti); n++) {
                for (const combo of combinations(validi, n)) {
                    const somma = combo.reduce((sum, m) => sum + (m[campoImporto] || 0), 0);
                    // Arrotonda a 2 decimali per evitare errori floating point
                    const diff = Math.round(Math.abs(somma - target) * 100) / 100;
                    if (diff <= config.tolleranzaImporto) {
                        return combo;
                    }
                }
            }
            
            return null;
        }
        
        function trovaCombinazioniMoltiA1(movimenti, target, dataTarget, campoImporto, config, tolleranzaGiorni = 0) {
            const validi = movimenti.filter(m => {
                if (m.conciliato || !m.data || !dataTarget) return false;
                
                const diffGiorni = Math.abs((m.data.getTime() - dataTarget.getTime()) / (1000 * 60 * 60 * 24));
                return diffGiorni <= tolleranzaGiorni;
            });
            
            if (validi.length < 2) return null;
            
            for (let n = 2; n <= Math.min(validi.length, config.maxMovimenti); n++) {
                for (const combo of combinations(validi, n)) {
                    const somma = combo.reduce((sum, m) => sum + (m[campoImporto] || 0), 0);
                    // Arrotonda a 2 decimali per evitare errori floating point
                    const diff = Math.round(Math.abs(somma - target) * 100) / 100;
                    if (diff <= config.tolleranzaImporto) {
                        return combo;
                    }
                }
            }
            
            return null;
        }
        
        function concilia(estratto, mast, config, periodi, onProgress, isIncremental = false) {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log(`ðŸ”„ INIZIO CONCILIAZIONE ${isIncremental ? '(INCREMENTALE)' : 'v3'}`);
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ðŸ“… Anno riferimento:', annoRiferimento);
            console.log('ðŸ“‹ Periodi selezionati:', periodi);
            console.log('âš™ï¸  Configurazione:', config);
            
            // Debug dati di input
            console.log('ðŸ“Š ESTRATTO CONTO - movimenti totali:', estratto.length);
            console.log('   - Entrate:', estratto.filter(m => m.entrate).length);
            console.log('   - Uscite:', estratto.filter(m => m.uscite).length);
            console.log('   - Con data valida:', estratto.filter(m => m.data).length);
            
            console.log('ðŸ“Š MASTRINO - movimenti totali:', mast.length);
            console.log('   - DARE:', mast.filter(m => m.dare).length);
            console.log('   - AVERE:', mast.filter(m => m.avere).length);
            console.log('   - Con data valida:', mast.filter(m => m.data).length);
            
            // Filtra per periodo
            let estrattoFiltrato = estratto;
            let mastFiltrato = mast;
            
            if (periodi && periodi.length > 0 && annoRiferimento) {
                console.log(`ðŸ“ Filtro per periodo (anno ${annoRiferimento})...`);
                
                estrattoFiltrato = estratto.filter(m => {
                    if (!m.data) return false;
                    return periodi.some(q => isInTrimestre(m.data, q, annoRiferimento));
                });
                
                mastFiltrato = mast.filter(m => {
                    if (!m.data) return false;
                    return periodi.some(q => isInTrimestre(m.data, q, annoRiferimento));
                });
                
                console.log(`   âœ“ Estratto filtrato: ${estrattoFiltrato.length} movimenti`);
                console.log(`   âœ“ Mastrino filtrato: ${mastFiltrato.length} movimenti`);
            }
            
            const entrate = estrattoFiltrato.filter(m => {
                if (!m.entrate) return false;
                // In modalitÃ  incrementale, salta i conciliati sicuri
                if (isIncremental && m.conciliato_sicuro) return false;
                return true;
            });
            const uscite = estrattoFiltrato.filter(m => {
                if (!m.uscite) return false;
                if (isIncremental && m.conciliato_sicuro) return false;
                return true;
            });
            const dare = mastFiltrato.filter(m => {
                if (!m.dare) return false;
                if (isIncremental && m.conciliato_sicuro) return false;
                return true;
            });
            const avere = mastFiltrato.filter(m => {
                if (!m.avere) return false;
                if (isIncremental && m.conciliato_sicuro) return false;
                return true;
            });
            
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ðŸ“Š DATI FILTRATI:');
            console.log('   Entrate banca:', entrate.length);
            console.log('   Uscite banca:', uscite.length);
            console.log('   DARE mastrino:', dare.length);
            console.log('   AVERE mastrino:', avere.length);
            if (isIncremental) {
                console.log('   (Esclusi movimenti conciliati sicuri dalla prima passata)');
            }
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            let progress = 0;
            const totalSteps = 16;
            
            console.log('');
            console.log('â–¶â–¶â–¶ FASE 1: Conciliazione con DATA ESATTA â—€â—€â—€');
            console.log('');
            
            // 1. Entrate 1-a-molti
            console.log('1ï¸âƒ£  Entrate 1-a-molti (data esatta)...');
            progress++;
            onProgress(progress / totalSteps * 50);
            let contatore = 0;
            entrate.forEach(e => {
                if (e.conciliato) return;
                const combo = trovaCombinazioni(dare, e.entrate, e.data, 'dare', config, 0);
                if (combo) {
                    // Determina se Ã¨ un match sicuro (1-a-1, data esatta, importo quasi esatto)
                    const isSicuro = !isIncremental && combo.length === 1 && 
                                     isMatchSicuro(e, combo[0], e.entrate, combo[0].dare, config, 0);
                    
                    e.conciliato = true;
                    e.conciliato_sicuro = isSicuro;
                    e.num_movimenti_mastrino = combo.length;
                    e.num_movimenti_banca = 1;
                    e.mastrino_progs = combo.map(m => m.prog).join(', ');
                    combo.forEach(m => {
                        m.conciliato = true;
                        m.conciliato_sicuro = isSicuro;
                        m.banca_prog = e.prog;
                    });
                    contatore++;
                    console.log(`   âœ“ ${e.prog} (â‚¬${formatImportoItaliano(e.entrate)}) â†’ ${e.mastrino_progs}${isSicuro ? ' ðŸ”’' : ''}`);
                }
            });
            console.log(`   Totale conciliate: ${contatore}\n`);
            
            // 2. Entrate molti-a-1
            console.log('2ï¸âƒ£  Entrate molti-a-1 (data esatta)...');
            progress++;
            onProgress(progress / totalSteps * 50);
            contatore = 0;
            dare.forEach(d => {
                if (d.conciliato) return;
                const combo = trovaCombinazioniMoltiA1(entrate, d.dare, d.data, 'entrate', config, 0);
                if (combo) {
                    d.conciliato = true;
                    d.banca_prog = combo.map(e => e.prog).join(', ');
                    d.num_movimenti_banca = combo.length;
                    combo.forEach(e => {
                        e.conciliato = true;
                        e.num_movimenti_mastrino = 1;
                        e.num_movimenti_banca = combo.length;
                        e.mastrino_progs = d.prog;
                        e.banca_progs = combo.map(x => x.prog).join(', ');
                    });
                    contatore++;
                    console.log(`   âœ“ ${d.prog} (â‚¬${formatImportoItaliano(d.dare)}) â† ${d.banca_prog}`);
                }
            });
            console.log(`   Totale conciliate: ${contatore}\n`);
            
            // 3. Uscite 1-a-molti (commissioni nel mastrino)
            console.log('3ï¸âƒ£  Uscite 1-a-molti con commissioni NEL mastrino (data esatta)...');
            progress++;
            onProgress(progress / totalSteps * 50);
            contatore = 0;
            uscite.forEach(u => {
                if (u.conciliato) return;
                
                // DEBUG per E71
                if (u.prog === 'E71') {
                    console.log('ðŸ” DEBUG E71:');
                    console.log('  Importo uscita:', u.uscite);
                    console.log('  Data:', formatData(u.data), 'timestamp:', u.data.getTime());
                    const avereDisponibili = avere.filter(a => !a.conciliato && a.data && u.data && a.data.getTime() === u.data.getTime());
                    console.log('  AVERE con stessa data (esatta):', avereDisponibili.map(a => `${a.prog}:${a.avere}`).join(', '));
                    console.log('  Tolleranza importo:', config.tolleranzaImporto);
                    console.log('  Tolleranza giorni:', 0);
                    
                    // Verifica manuale M103
                    const m103 = avere.find(a => a.prog === 'M103');
                    if (m103) {
                        console.log('  M103 trovato:');
                        console.log('    - conciliato?', m103.conciliato);
                        console.log('    - data:', formatData(m103.data), 'timestamp:', m103.data.getTime());
                        console.log('    - avere:', m103.avere);
                        console.log('    - diff importo:', Math.abs(m103.avere - u.uscite));
                        console.log('    - diff data (ms):', Math.abs(m103.data.getTime() - u.data.getTime()));
                        console.log('    - diff data (giorni):', Math.abs(m103.data.getTime() - u.data.getTime()) / (1000 * 60 * 60 * 24));
                        console.log('    - passa tolleranza importo?', Math.abs(m103.avere - u.uscite) <= config.tolleranzaImporto);
                        console.log('    - passa tolleranza data?', Math.abs(m103.data.getTime() - u.data.getTime()) / (1000 * 60 * 60 * 24) <= 0);
                    }
                }
                
                const combo = trovaCombinazioni(avere, u.uscite, u.data, 'avere', config, 0);
                
                // DEBUG per E71
                if (u.prog === 'E71') {
                    console.log('  Combo trovata:', combo ? combo.map(c => `${c.prog}:${c.avere}`).join(', ') : 'NESSUNA');
                }
                
                if (combo) {
                    let commissione = 0;
                    const progs = [];
                    const movimentiNonCommissione = combo.filter(a => !isCommissioneAmmessa(a.avere, config.tolleranzaImporto));
                    
                    // Determina se Ã¨ un match sicuro
                    const isSicuro = !isIncremental && 
                                     movimentiNonCommissione.length === 1 && 
                                     combo.length <= 2 && // max 1 movimento + eventuale commissione
                                     isMatchSicuro(u, movimentiNonCommissione[0], u.uscite - commissione, movimentiNonCommissione[0].avere, config, 0);
                    
                    combo.forEach(a => {
                        if (isCommissioneAmmessa(a.avere, config.tolleranzaImporto)) {
                            commissione = a.avere;
                            a.tipo = 'commissione';
                        } else {
                            progs.push(a.prog);
                        }
                        a.conciliato = true;
                        a.conciliato_sicuro = isSicuro;
                        a.banca_prog = u.prog;
                        a.num_movimenti_banca = 1;
                    });
                    u.conciliato = true;
                    u.conciliato_sicuro = isSicuro;
                    u.num_movimenti_mastrino = combo.length;
                    u.num_movimenti_banca = 1;
                    u.commissione_mastrino = commissione;
                    u.mastrino_progs = progs.join(', ');
                    contatore++;
                    if (commissione > 0) {
                        console.log(`   âœ“ ${u.prog} (â‚¬${formatImportoItaliano(u.uscite)}) â†’ ${u.mastrino_progs} + COMM â‚¬${formatImportoItaliano(commissione)}${isSicuro ? ' ðŸ”’' : ''}`);
                    } else {
                        console.log(`   âœ“ ${u.prog} (â‚¬${formatImportoItaliano(u.uscite)}) â†’ ${u.mastrino_progs}${isSicuro ? ' ðŸ”’' : ''}`);
                    }
                }
            });
            console.log(`   Totale conciliate: ${contatore}\n`);
            
            // 4. Uscite con commissioni calcolate
            console.log('4ï¸âƒ£  Uscite 1-a-molti con commissioni CALCOLATE (data esatta)...');
            progress++;
            onProgress(progress / totalSteps * 50);
            contatore = 0;
            uscite.forEach(u => {
                if (u.conciliato) return;
                for (const comm of COMMISSIONI_AMMESSE) {
                    const combo = trovaCombinazioni(avere, u.uscite - comm, u.data, 'avere', config, 0);
                    if (combo) {
                        u.conciliato = true;
                        u.num_movimenti_mastrino = combo.length;
                        u.num_movimenti_banca = 1;
                        u.commissione_calcolata = comm;
                        u.mastrino_progs = combo.map(m => m.prog).join(', ');
                        combo.forEach(a => {
                            a.conciliato = true;
                            a.banca_prog = u.prog;
                        });
                        
                        // Registra commissione calcolata nella tabella
                        aggiungiCommissioneDaRegistrare(comm, u.data, u.prog, u.descrizione, u.uscite);
                        
                        contatore++;
                        console.log(`   âœ“ ${u.prog} (â‚¬${formatImportoItaliano(u.uscite)}) â†’ ${u.mastrino_progs} + CALC â‚¬${formatImportoItaliano(comm)}`);
                        break;
                    }
                }
            });
            console.log(`   Totale conciliate: ${contatore}\n`);
            
            // 5. Uscite molti-a-1
            console.log('5ï¸âƒ£  Uscite molti-a-1 (data esatta)...');
            progress++;
            onProgress(progress / totalSteps * 50);
            contatore = 0;
            avere.forEach(a => {
                if (a.conciliato || isCommissioneAmmessa(a.avere)) return;
                const combo = trovaCombinazioniMoltiA1(uscite, a.avere, a.data, 'uscite', config, 0);
                if (combo) {
                    a.conciliato = true;
                    a.banca_prog = combo.map(u => u.prog).join(', ');
                    a.num_movimenti_banca = combo.length;
                    combo.forEach(u => {
                        u.conciliato = true;
                        u.num_movimenti_mastrino = 1;
                        u.num_movimenti_banca = combo.length;
                        u.mastrino_progs = a.prog;
                        u.banca_progs = combo.map(x => x.prog).join(', ');
                    });
                    contatore++;
                    console.log(`   âœ“ ${a.prog} (â‚¬${formatImportoItaliano(a.avere)}) â† ${a.banca_prog}`);
                }
            });
            console.log(`   Totale conciliate: ${contatore}\n`);
            
            // 5B. Uscite molti-a-1 con commissioni NEL mastrino (data esatta)
            console.log('5ï¸âƒ£B Uscite molti-a-1 con commissioni NEL mastrino (data esatta)...');
            progress++;
            onProgress(progress / totalSteps * 50);
            contatore = 0;
            
            avere.forEach(a => {
                if (a.conciliato || isCommissioneAmmessa(a.avere)) return;
                
                // Cerca combinazioni di uscite banca che includono commissioni nel mastrino
                // Target = AVERE + eventuali commissioni
                
                // Trova commissioni disponibili con stessa data
                const commDisponibili = avere.filter(comm => 
                    !comm.conciliato &&
                    isCommissioneAmmessa(comm.avere) &&
                    comm.data && a.data &&
                    comm.data.getTime() === a.data.getTime()
                );
                
                // Prova senza commissioni
                let combo = trovaCombinazioniMoltiA1(uscite, a.avere, a.data, 'uscite', config, 0);
                
                // Se non trova, prova con ciascuna commissione
                if (!combo && commDisponibili.length > 0) {
                    for (const comm of commDisponibili) {
                        const targetConComm = Math.round((a.avere + comm.avere) * 100) / 100;
                        combo = trovaCombinazioniMoltiA1(uscite, targetConComm, a.data, 'uscite', config, 0);
                        
                        if (combo) {
                            // Concilia movimento principale
                            a.conciliato = true;
                            a.banca_prog = combo.map(u => u.prog).join(', ');
                            a.num_movimenti_banca = combo.length;
                            
                            // Concilia commissione
                            comm.conciliato = true;
                            comm.tipo = 'commissione';
                            comm.banca_prog = a.banca_prog;
                            
                            // Concilia uscite banca
                            combo.forEach(u => {
                                u.conciliato = true;
                                u.num_movimenti_mastrino = 2; // movimento + commissione
                                u.num_movimenti_banca = combo.length;
                                u.mastrino_progs = a.prog;
                                u.commissione_mastrino = comm.avere;
                                u.banca_progs = combo.map(x => x.prog).join(', ');
                            });
                            
                            contatore++;
                            console.log(`   âœ“ ${a.prog} (â‚¬${formatImportoItaliano(a.avere)}) â† ${a.banca_prog} + COMM ${comm.prog} (â‚¬${formatImportoItaliano(comm.avere)})`);
                            break;
                        }
                    }
                } else if (combo) {
                    // Match trovato senza commissioni
                    a.conciliato = true;
                    a.banca_prog = combo.map(u => u.prog).join(', ');
                    a.num_movimenti_banca = combo.length;
                    combo.forEach(u => {
                        u.conciliato = true;
                        u.num_movimenti_mastrino = 1;
                        u.num_movimenti_banca = combo.length;
                        u.mastrino_progs = a.prog;
                        u.banca_progs = combo.map(x => x.prog).join(', ');
                    });
                    contatore++;
                    console.log(`   âœ“ ${a.prog} (â‚¬${formatImportoItaliano(a.avere)}) â† ${a.banca_prog}`);
                }
            });
            
            console.log(`   Totale conciliate: ${contatore}\n`);
            
            // 5C. Uscite molti-a-1 con commissioni CALCOLATE (data esatta)
            console.log('5ï¸âƒ£C Uscite molti-a-1 con commissioni CALCOLATE (data esatta)...');
            progress++;
            onProgress(progress / totalSteps * 50);
            contatore = 0;
            
            avere.forEach(a => {
                if (a.conciliato || isCommissioneAmmessa(a.avere)) return;
                
                // Prova con ciascuna commissione ammessa
                for (const comm of COMMISSIONI_AMMESSE) {
                    const targetConComm = Math.round((a.avere + comm) * 100) / 100;
                    const combo = trovaCombinazioniMoltiA1(uscite, targetConComm, a.data, 'uscite', config, 0);
                    
                    if (combo) {
                        // Concilia movimento principale
                        a.conciliato = true;
                        a.banca_prog = combo.map(u => u.prog).join(', ');
                        a.num_movimenti_banca = combo.length;
                        
                        // Concilia uscite banca
                        combo.forEach(u => {
                            u.conciliato = true;
                            u.num_movimenti_mastrino = 1;
                            u.num_movimenti_banca = combo.length;
                            u.mastrino_progs = a.prog;
                            u.commissione_calcolata = comm;
                            u.banca_progs = combo.map(x => x.prog).join(', ');
                            
                            // Registra commissione calcolata
                            aggiungiCommissioneDaRegistrare(comm, u.data, u.prog, u.descrizione, u.uscite);
                        });
                        
                        contatore++;
                        console.log(`   âœ“ ${a.prog} (â‚¬${formatImportoItaliano(a.avere)}) â† ${a.banca_prog} + CALC â‚¬${formatImportoItaliano(comm)}`);
                        break;
                    }
                }
            });
            
            console.log(`   Totale conciliate: ${contatore}\n`);
            
            // 11A. Riconciliazione commissioni calcolate (data esatta)
            console.log('');
            console.log('ðŸ”§ PASSAGGIO 11A: Riconciliazione commissioni calcolate (data esatta)');
            console.log('');
            progress++;
            onProgress(progress / totalSteps * 50);
            contatore = 0;
            
            // Usa for tradizionale per poter rimuovere elementi durante l'iterazione
            for (let i = commissioniDaRegistrare.length - 1; i >= 0; i--) {
                const commCalc = commissioniDaRegistrare[i];
                
                // Cerca AVERE mastrino con:
                // 1. Stesso importo (Â±0.01)
                // 2. Data ESATTA
                // 3. NON giÃ  conciliato
                // 4. Ãˆ una commissione ammessa
                const match = avere.find(a => 
                    !a.conciliato &&
                    isCommissioneAmmessa(a.avere) &&
                    Math.abs(a.avere - commCalc.importo) <= 0.01 &&
                    a.data && commCalc.data_banca &&
                    a.data.getTime() === commCalc.data_banca.getTime()
                );
                
                if (match) {
                    // 1. Concilia la commissione nel mastrino
                    match.conciliato = true;
                    match.tipo = 'commissione';
                    match.banca_prog = commCalc.prog_banca;
                    match.num_movimenti_banca = 1;
                    
                    // 2. Aggiorna l'uscita bancaria
                    const uscitaBanca = uscite.find(u => u.prog === commCalc.prog_banca);
                    if (uscitaBanca) {
                        // Aggiungi prog commissione a mastrino_progs
                        if (uscitaBanca.mastrino_progs) {
                            uscitaBanca.mastrino_progs += ', ' + match.prog;
                        } else {
                            uscitaBanca.mastrino_progs = match.prog;
                        }
                        
                        // Rimuovi commissione_calcolata e sostituisci con commissione_mastrino
                        if (uscitaBanca.commissione_calcolata) {
                            uscitaBanca.commissione_mastrino = uscitaBanca.commissione_calcolata;
                            uscitaBanca.commissione_calcolata = 0;
                        }
                        
                        // Incrementa contatore movimenti mastrino
                        if (uscitaBanca.num_movimenti_mastrino) {
                            uscitaBanca.num_movimenti_mastrino++;
                        } else {
                            uscitaBanca.num_movimenti_mastrino = 1;
                        }
                    }
                    
                    // 3. ELIMINA FISICAMENTE la commissione dalla tabella
                    commissioniDaRegistrare.splice(i, 1);
                    
                    contatore++;
                    console.log(`   âœ“ ${commCalc.prog_banca}: Commissione â‚¬${formatImportoItaliano(commCalc.importo)} â†’ ${match.prog}`);
                }
            }
            
            console.log(`   Totale commissioni riconciliate: ${contatore}`);
            console.log('');
            
            console.log('');
            console.log(`â–¶â–¶â–¶ FASE 2: Conciliazione con TOLLERANZA Â±${config.tolleranzaGiorni} GIORNI â—€â—€â—€`);
            console.log('');
            
            const tolGiorni = parseInt(config.tolleranzaGiorni);
            
            // Ripete con tolleranza
            console.log('6ï¸âƒ£  Entrate 1-a-molti (tolleranza)...');
            progress++;
            onProgress(progress / totalSteps * 50 + 50);
            contatore = 0;
            entrate.filter(e => !e.conciliato).forEach(e => {
                const combo = trovaCombinazioni(dare, e.entrate, e.data, 'dare', config, tolGiorni);
                if (combo) {
                    e.conciliato = true;
                    e.num_movimenti_mastrino = combo.length;
                    e.num_movimenti_banca = 1;
                    e.mastrino_progs = combo.map(m => m.prog).join(', ');
                    combo.forEach(m => {
                        m.conciliato = true;
                        m.banca_prog = e.prog;
                    });
                    contatore++;
                    console.log(`   âœ“ ${e.prog} â†’ ${e.mastrino_progs} (con tolleranza)`);
                }
            });
            console.log(`   Totale conciliate: ${contatore}\n`);
            
            console.log('7ï¸âƒ£  Entrate molti-a-1 (tolleranza)...');
            progress++;
            onProgress(progress / totalSteps * 50 + 50);
            contatore = 0;
            dare.filter(d => !d.conciliato).forEach(d => {
                const combo = trovaCombinazioniMoltiA1(entrate, d.dare, d.data, 'entrate', config, tolGiorni);
                if (combo) {
                    d.conciliato = true;
                    d.banca_prog = combo.map(e => e.prog).join(', ');
                    d.num_movimenti_banca = combo.length;
                    combo.forEach(e => {
                        e.conciliato = true;
                        e.num_movimenti_mastrino = 1;
                        e.num_movimenti_banca = combo.length;
                        e.mastrino_progs = d.prog;
                        e.banca_progs = combo.map(x => x.prog).join(', ');
                    });
                    contatore++;
                }
            });
            console.log(`   Totale conciliate: ${contatore}\n`);
            
            console.log('8ï¸âƒ£  Uscite 1-a-molti con commissioni NEL mastrino (tolleranza)...');
            progress++;
            onProgress(progress / totalSteps * 50 + 50);
            contatore = 0;
            uscite.filter(u => !u.conciliato).forEach(u => {
                const combo = trovaCombinazioni(avere, u.uscite, u.data, 'avere', config, tolGiorni);
                if (combo) {
                    let commissione = 0;
                    const progs = [];
                    combo.forEach(a => {
                        if (isCommissioneAmmessa(a.avere)) {
                            commissione = a.avere;
                            a.tipo = 'commissione';
                        } else {
                            progs.push(a.prog);
                        }
                        a.conciliato = true;
                        a.banca_prog = u.prog;
                    });
                    u.conciliato = true;
                    u.num_movimenti_mastrino = combo.length;
                    u.num_movimenti_banca = 1;
                    u.commissione_mastrino = commissione;
                    u.mastrino_progs = progs.join(', ');
                    contatore++;
                }
            });
            console.log(`   Totale conciliate: ${contatore}\n`);
            
            console.log('9ï¸âƒ£  Uscite 1-a-molti con commissioni CALCOLATE (tolleranza)...');
            progress++;
            onProgress(progress / totalSteps * 50 + 50);
            contatore = 0;
            uscite.filter(u => !u.conciliato).forEach(u => {
                for (const comm of COMMISSIONI_AMMESSE) {
                    const combo = trovaCombinazioni(avere, u.uscite - comm, u.data, 'avere', config, tolGiorni);
                    if (combo) {
                        u.conciliato = true;
                        u.num_movimenti_mastrino = combo.length;
                        u.num_movimenti_banca = 1;
                        u.commissione_calcolata = comm;
                        u.mastrino_progs = combo.map(m => m.prog).join(', ');
                        combo.forEach(a => {
                            a.conciliato = true;
                            a.banca_prog = u.prog;
                        });
                        
                        // Registra commissione calcolata nella tabella
                        aggiungiCommissioneDaRegistrare(comm, u.data, u.prog, u.descrizione, u.uscite);
                        
                        contatore++;
                        break;
                    }
                }
            });
            console.log(`   Totale conciliate: ${contatore}\n`);
            
            console.log('ðŸ”Ÿ Uscite molti-a-1 (tolleranza)...');
            progress++;
            onProgress(progress / totalSteps * 50 + 50);
            contatore = 0;
            avere.filter(a => !a.conciliato && !isCommissioneAmmessa(a.avere)).forEach(a => {
                const combo = trovaCombinazioniMoltiA1(uscite, a.avere, a.data, 'uscite', config, tolGiorni);
                if (combo) {
                    a.conciliato = true;
                    a.banca_prog = combo.map(u => u.prog).join(', ');
                    a.num_movimenti_banca = combo.length;
                    combo.forEach(u => {
                        u.conciliato = true;
                        u.num_movimenti_mastrino = 1;
                        u.num_movimenti_banca = combo.length;
                        u.mastrino_progs = a.prog;
                        u.banca_progs = combo.map(x => x.prog).join(', ');
                    });
                    contatore++;
                }
            });
            console.log(`   Totale conciliate: ${contatore}\n`);
            
            // 10B. Uscite molti-a-1 con commissioni NEL mastrino (tolleranza)
            console.log('ðŸ”ŸB Uscite molti-a-1 con commissioni NEL mastrino (tolleranza)...');
            progress++;
            onProgress(progress / totalSteps * 50 + 50);
            contatore = 0;
            
            avere.filter(a => !a.conciliato && !isCommissioneAmmessa(a.avere)).forEach(a => {
                
                // Trova commissioni disponibili entro tolleranza giorni
                const commDisponibili = avere.filter(comm => 
                    !comm.conciliato &&
                    isCommissioneAmmessa(comm.avere) &&
                    comm.data && a.data &&
                    Math.abs((comm.data.getTime() - a.data.getTime()) / (1000 * 60 * 60 * 24)) <= tolGiorni
                );
                
                // Prova senza commissioni
                let combo = trovaCombinazioniMoltiA1(uscite, a.avere, a.data, 'uscite', config, tolGiorni);
                
                // Se non trova, prova con ciascuna commissione
                if (!combo && commDisponibili.length > 0) {
                    for (const comm of commDisponibili) {
                        const targetConComm = Math.round((a.avere + comm.avere) * 100) / 100;
                        combo = trovaCombinazioniMoltiA1(uscite, targetConComm, a.data, 'uscite', config, tolGiorni);
                        
                        if (combo) {
                            // Concilia movimento principale
                            a.conciliato = true;
                            a.banca_prog = combo.map(u => u.prog).join(', ');
                            a.num_movimenti_banca = combo.length;
                            
                            // Concilia commissione
                            comm.conciliato = true;
                            comm.tipo = 'commissione';
                            comm.banca_prog = a.banca_prog;
                            
                            // Concilia uscite banca
                            combo.forEach(u => {
                                u.conciliato = true;
                                u.num_movimenti_mastrino = 2;
                                u.num_movimenti_banca = combo.length;
                                u.mastrino_progs = a.prog;
                                u.commissione_mastrino = comm.avere;
                                u.banca_progs = combo.map(x => x.prog).join(', ');
                            });
                            
                            contatore++;
                            break;
                        }
                    }
                } else if (combo) {
                    // Match trovato senza commissioni
                    a.conciliato = true;
                    a.banca_prog = combo.map(u => u.prog).join(', ');
                    a.num_movimenti_banca = combo.length;
                    combo.forEach(u => {
                        u.conciliato = true;
                        u.num_movimenti_mastrino = 1;
                        u.num_movimenti_banca = combo.length;
                        u.mastrino_progs = a.prog;
                        u.banca_progs = combo.map(x => x.prog).join(', ');
                    });
                    contatore++;
                }
            });
            
            console.log(`   Totale conciliate: ${contatore}\n`);
            
            // 10C. Uscite molti-a-1 con commissioni CALCOLATE (tolleranza)
            console.log('ðŸ”ŸC Uscite molti-a-1 con commissioni CALCOLATE (tolleranza)...');
            progress++;
            onProgress(progress / totalSteps * 50 + 50);
            contatore = 0;
            
            avere.filter(a => !a.conciliato && !isCommissioneAmmessa(a.avere)).forEach(a => {
                
                // Prova con ciascuna commissione ammessa
                for (const comm of COMMISSIONI_AMMESSE) {
                    const targetConComm = Math.round((a.avere + comm) * 100) / 100;
                    const combo = trovaCombinazioniMoltiA1(uscite, targetConComm, a.data, 'uscite', config, tolGiorni);
                    
                    if (combo) {
                        // Concilia movimento principale
                        a.conciliato = true;
                        a.banca_prog = combo.map(u => u.prog).join(', ');
                        a.num_movimenti_banca = combo.length;
                        
                        // Concilia uscite banca
                        combo.forEach(u => {
                            u.conciliato = true;
                            u.num_movimenti_mastrino = 1;
                            u.num_movimenti_banca = combo.length;
                            u.mastrino_progs = a.prog;
                            u.commissione_calcolata = comm;
                            u.banca_progs = combo.map(x => x.prog).join(', ');
                            
                            // Registra commissione calcolata
                            aggiungiCommissioneDaRegistrare(comm, u.data, u.prog, u.descrizione, u.uscite);
                        });
                        
                        contatore++;
                        break;
                    }
                }
            });
            
            console.log(`   Totale conciliate: ${contatore}\n`);
            
            // 11B. Riconciliazione commissioni calcolate (tolleranza giorni)
            console.log('');
            console.log('ðŸ”§ PASSAGGIO 11B: Riconciliazione commissioni calcolate (tolleranza giorni)');
            console.log('');
            progress++;
            onProgress(100);
            contatore = 0;
            
            // Usa for tradizionale per poter rimuovere elementi durante l'iterazione
            for (let i = commissioniDaRegistrare.length - 1; i >= 0; i--) {
                const commCalc = commissioniDaRegistrare[i];
                
                // Cerca AVERE mastrino con:
                // 1. Stesso importo (Â±0.01)
                // 2. Data entro tolleranza giorni
                // 3. NON giÃ  conciliato
                // 4. Ãˆ una commissione ammessa
                // 5. Prendi il PIÃ™ VICINO
                
                let miglioreMatch = null;
                let minDiffGiorni = Infinity;
                
                avere.filter(a => 
                    !a.conciliato &&
                    isCommissioneAmmessa(a.avere) &&
                    Math.abs(a.avere - commCalc.importo) <= 0.01 &&
                    a.data && commCalc.data_banca
                ).forEach(a => {
                    const diffGiorni = Math.abs((a.data.getTime() - commCalc.data_banca.getTime()) / (1000 * 60 * 60 * 24));
                    
                    if (diffGiorni <= tolGiorni && diffGiorni < minDiffGiorni) {
                        minDiffGiorni = diffGiorni;
                        miglioreMatch = a;
                    }
                });
                
                if (miglioreMatch) {
                    // 1. Concilia la commissione nel mastrino
                    miglioreMatch.conciliato = true;
                    miglioreMatch.tipo = 'commissione';
                    miglioreMatch.banca_prog = commCalc.prog_banca;
                    miglioreMatch.num_movimenti_banca = 1;
                    
                    // 2. Aggiorna l'uscita bancaria
                    const uscitaBanca = uscite.find(u => u.prog === commCalc.prog_banca);
                    if (uscitaBanca) {
                        // Aggiungi prog commissione a mastrino_progs
                        if (uscitaBanca.mastrino_progs) {
                            uscitaBanca.mastrino_progs += ', ' + miglioreMatch.prog;
                        } else {
                            uscitaBanca.mastrino_progs = miglioreMatch.prog;
                        }
                        
                        // Rimuovi commissione_calcolata e sostituisci con commissione_mastrino
                        if (uscitaBanca.commissione_calcolata) {
                            uscitaBanca.commissione_mastrino = uscitaBanca.commissione_calcolata;
                            uscitaBanca.commissione_calcolata = 0;
                        }
                        
                        // Incrementa contatore movimenti mastrino
                        if (uscitaBanca.num_movimenti_mastrino) {
                            uscitaBanca.num_movimenti_mastrino++;
                        } else {
                            uscitaBanca.num_movimenti_mastrino = 1;
                        }
                    }
                    
                    // 3. ELIMINA FISICAMENTE la commissione dalla tabella
                    commissioniDaRegistrare.splice(i, 1);
                    
                    contatore++;
                    console.log(`   âœ“ ${commCalc.prog_banca}: Commissione â‚¬${formatImportoItaliano(commCalc.importo)} â†’ ${miglioreMatch.prog} (diff: ${minDiffGiorni}gg)`);
                }
            }
            
            console.log(`   Totale commissioni riconciliate: ${contatore}`);
            console.log('');
            
            onProgress(100);
            
            const entrateConc = entrate.filter(e => e.conciliato).length;
            const usciteConc = uscite.filter(u => u.conciliato).length;
            
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('âœ… CONCILIAZIONE COMPLETATA');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log(`ðŸ“Š ENTRATE: ${entrateConc}/${entrate.length} conciliate (${(entrateConc/entrate.length*100).toFixed(1)}%)`);
            console.log(`ðŸ“Š USCITE: ${usciteConc}/${uscite.length} conciliate (${(usciteConc/uscite.length*100).toFixed(1)}%)`);
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
            
            return { entrate: estrattoFiltrato, uscite: [], dare: dare, avere: avere };
        }
        
        // === VISUALIZZAZIONE RISULTATI ===
        
        // === NUOVE FUNZIONI PER V3 ===

        // Variabile globale per i dati attuali
        let datiEstrattoConto = [];
        let datiMastrino = [];
        let filtriAttivi = {
            tipo: 'all', // 'all', 'entrate-dare', 'uscite-avere'
            stato: 'all' // 'all', 'conciliati', 'non-conciliati'
        };

        function mostraRisultati(ris) {
            console.log('ðŸ“Š Visualizzazione risultati v4...');

            const entrate = ris.entrate.filter(m => m.entrate);
            const uscite = ris.entrate.filter(m => m.uscite);

            const entrateConc = entrate.filter(e => e.conciliato).length;
            const usciteConc = uscite.filter(u => u.conciliato).length;
            const commCalc = commissioniDaRegistrare.reduce((s, c) => s + c.importo, 0);

            // Summary cards
            const summaryHTML = `
                <div class="summary-card">
                    <h3>Entrate Conciliate</h3>
                    <div class="value">${entrateConc}</div>
                    <div class="percentage">${entrate.length > 0 ? (entrateConc/entrate.length*100).toFixed(1) : 0}%</div>
                </div>
                <div class="summary-card">
                    <h3>Entrate NON Conciliate</h3>
                    <div class="value">${entrate.length - entrateConc}</div>
                </div>
                <div class="summary-card">
                    <h3>Uscite Conciliate</h3>
                    <div class="value">${usciteConc}</div>
                    <div class="percentage">${uscite.length > 0 ? (usciteConc/uscite.length*100).toFixed(1) : 0}%</div>
                </div>
                <div class="summary-card">
                    <h3>Uscite NON Conciliate</h3>
                    <div class="value">${uscite.length - usciteConc}</div>
                </div>
                <div class="summary-card">
                    <h3>Commissioni da registrare</h3>
                    <div class="value">${commissioniDaRegistrare.length}</div>
                    <div class="percentage">â‚¬ ${formatImportoItaliano(commCalc)}</div>
                </div>
            `;
            document.getElementById('summaryGrid').innerHTML = summaryHTML;

            // Prepara dati per le nuove tabelle
            datiEstrattoConto = [...entrate, ...uscite].sort((a, b) => {
                const progA = parseInt(a.prog.replace(/[^0-9]/g, '')) || 0;
                const progB = parseInt(b.prog.replace(/[^0-9]/g, '')) || 0;
                return progA - progB;
            });

            datiMastrino = [...ris.dare, ...ris.avere].sort((a, b) => {
                const progA = parseInt(a.prog.replace(/[^0-9]/g, '')) || 0;
                const progB = parseInt(b.prog.replace(/[^0-9]/g, '')) || 0;
                return progA - progB;
            });

            // Popola le nuove tabelle
            popolaTabellaEstrattoConto();
            popolaTabellaMastrino();

            // Tabella commissioni (invariata)
            popolaTabellaCommissioni();

            document.getElementById('results-section').style.display = 'block';
            mostraDownloadFab();
            
            // Verifica discordanze e mostra/nasconde alert
            verificaDiscordanzeMastrino(entrate, uscite, ris.dare, ris.avere);
        }
        
        function verificaDiscordanzeMastrino(entrate, uscite, dare, avere) {
            // Calcola totali non conciliati
            const totaleUsciteNonConc = uscite.filter(u => !u.conciliato).reduce((s, u) => s + (u.uscite || 0), 0);
            const totaleEntrateNonConc = entrate.filter(e => !e.conciliato).reduce((s, e) => s + (e.entrate || 0), 0);
            
            const totaleAvereNonConc = avere.filter(a => !a.conciliato).reduce((s, a) => s + (a.avere || 0), 0);
            const totaleDareNonConc = dare.filter(d => !d.conciliato).reduce((s, d) => s + (d.dare || 0), 0);
            
            // Arrotonda per evitare errori floating point
            const diffUsciteAvere = Math.round(Math.abs(totaleUsciteNonConc - totaleAvereNonConc) * 100) / 100;
            const diffEntrateDare = Math.round(Math.abs(totaleEntrateNonConc - totaleDareNonConc) * 100) / 100;
            
            const alertElement = document.getElementById('mastrino-alert');
            
            // Mostra alert se almeno una differenza > 0.01 (tolleranza)
            if (diffUsciteAvere > 0.01 || diffEntrateDare > 0.01) {
                alertElement.style.display = 'inline-flex';
                
                // Aggiorna il tooltip con i dettagli
                let tooltipText = 'DISCORDANZE RILEVATE:\n';
                if (diffUsciteAvere > 0.01) {
                    tooltipText += `\nUscite non conc: â‚¬${formatImportoItaliano(totaleUsciteNonConc)}`;
                    tooltipText += `\nAVERE non conc: â‚¬${formatImportoItaliano(totaleAvereNonConc)}`;
                    tooltipText += `\nDifferenza: â‚¬${formatImportoItaliano(diffUsciteAvere)}`;
                }
                if (diffEntrateDare > 0.01) {
                    if (diffUsciteAvere > 0.01) tooltipText += '\n---';
                    tooltipText += `\nEntrate non conc: â‚¬${formatImportoItaliano(totaleEntrateNonConc)}`;
                    tooltipText += `\nDARE non conc: â‚¬${formatImportoItaliano(totaleDareNonConc)}`;
                    tooltipText += `\nDifferenza: â‚¬${formatImportoItaliano(diffEntrateDare)}`;
                }
                
                alertElement.title = tooltipText;
            } else {
                alertElement.style.display = 'none';
            }
        }

        function popolaTabellaEstrattoConto() {
            const table = document.getElementById('table-estratto-conto');

            if (datiEstrattoConto.length === 0) {
                table.innerHTML = `<div class="empty-state"><p>Nessun dato disponibile</p></div>`;
                return;
            }

            let html = `
                <thead>
                    <tr>
                        <th>Stato</th>
                        <th>Prog Banca</th>
                        <th>Data</th>
                        <th>Descrizione</th>
                        <th class="col-uscite" style="text-align: right;">Uscite</th>
                        <th class="col-entrate" style="text-align: right;">Entrate</th>
                        <th>Prog Mastrino</th>
                        <th style="text-align: right;">Commissioni da registrare</th>
                        <th style="text-align: center;">N.Mov Mastrino</th>
                    </tr>
                </thead>
                <tbody>
            `;

            datiEstrattoConto.forEach(row => {
                const isEntrata = row.entrate > 0;
                const isUscita = row.uscite > 0;
                const isConciliato = row.conciliato || false;

                // Badge stato
                const badgeStato = isConciliato 
                    ? '<span class="badge-stato badge-conciliato">Conciliato</span>'
                    : '<span class="badge-stato badge-non-conciliato">Non Conciliato</span>';

                // Importi
                const usciteStr = isUscita ? `<span class="importo-uscita">${formatImportoItaliano(row.uscite)}</span>` : '';
                const entrateStr = isEntrata ? `<span class="importo-entrata">${formatImportoItaliano(row.entrate)}</span>` : '';

                // Commissioni da registrare (solo quelle calcolate)
                const commissioniStr = row.commissione_calcolata ? `<span class="importo-uscita">${formatImportoItaliano(row.commissione_calcolata)}</span>` : '';

                // Prog Mastrino e N.Mov
                const progMastrinoStr = row.mastrino_progs || '';
                const nMovMastrinoStr = row.num_movimenti_mastrino || '';

                // Data attributes per filtri
                const tipoData = isEntrata ? 'entrata' : 'uscita';
                const statoData = isConciliato ? 'conciliato' : 'non-conciliato';

                html += `
                    <tr data-tipo="${tipoData}" data-stato="${statoData}" data-uscite="${row.uscite || 0}" data-entrate="${row.entrate || 0}">
                        <td>${badgeStato}</td>
                        <td>${row.prog}</td>
                        <td>${formatData(row.data)}</td>
                        <td>${row.descrizione || ''}</td>
                        <td class="col-uscite" style="text-align: right;">${usciteStr}</td>
                        <td class="col-entrate" style="text-align: right;">${entrateStr}</td>
                        <td>${progMastrinoStr}</td>
                        <td style="text-align: right;">${commissioniStr}</td>
                        <td style="text-align: center;">${nMovMastrinoStr}</td>
                    </tr>
                `;
            });

            // Calcola totali
            const totaleUscite = datiEstrattoConto.reduce((sum, row) => sum + (row.uscite || 0), 0);
            const totaleEntrate = datiEstrattoConto.reduce((sum, row) => sum + (row.entrate || 0), 0);

            html += `
                </tbody>
                <tfoot>
                    <tr class="totals-row">
                        <td colspan="4" style="text-align: right; font-weight: 700;">TOTALE:</td>
                        <td class="col-uscite" style="text-align: right; font-weight: 700;"><span class="importo-uscita">${formatImportoItaliano(totaleUscite)}</span></td>
                        <td class="col-entrate" style="text-align: right; font-weight: 700;"><span class="importo-entrata">${formatImportoItaliano(totaleEntrate)}</span></td>
                        <td colspan="3"></td>
                    </tr>
                </tfoot>
            `;
            table.innerHTML = html;
        }

        function popolaTabellaMastrino() {
            const table = document.getElementById('table-mastrino');

            if (datiMastrino.length === 0) {
                table.innerHTML = `<div class="empty-state"><p>Nessun dato disponibile</p></div>`;
                return;
            }

            let html = `
                <thead>
                    <tr>
                        <th>Stato</th>
                        <th>Prog Mastrino</th>
                        <th>Data Reg</th>
                        <th>Num Doc</th>
                        <th>Descrizione</th>
                        <th class="col-dare" style="text-align: right;">Dare</th>
                        <th class="col-avere" style="text-align: right;">Avere</th>
                        <th>Prog Banca</th>
                        <th style="text-align: center;">N.Mov Banca</th>
                    </tr>
                </thead>
                <tbody>
            `;

            datiMastrino.forEach(row => {
                const isDare = row.dare > 0;
                const isAvere = row.avere > 0;
                const isConciliato = row.conciliato || false;

                // Badge stato
                const badgeStato = isConciliato 
                    ? '<span class="badge-stato badge-conciliato">Conciliato</span>'
                    : '<span class="badge-stato badge-non-conciliato">Non Conciliato</span>';

                // Importi
                const dareStr = isDare ? `<span class="importo-dare">${formatImportoItaliano(row.dare)}</span>` : '';
                const avereStr = isAvere ? `<span class="importo-avere">${formatImportoItaliano(row.avere)}</span>` : '';

                // Prog Banca e N.Mov
                const progBancaStr = row.banca_prog || '';
                const nMovBancaStr = row.num_movimenti_banca || '';

                // Data attributes per filtri
                const tipoData = isDare ? 'dare' : 'avere';
                const statoData = isConciliato ? 'conciliato' : 'non-conciliato';

                html += `
                    <tr data-tipo="${tipoData}" data-stato="${statoData}" data-dare="${row.dare || 0}" data-avere="${row.avere || 0}">
                        <td>${badgeStato}</td>
                        <td>${row.prog}</td>
                        <td>${formatData(row.data)}</td>
                        <td>${row.num_doc || ''}</td>
                        <td>${row.descrizione || ''}</td>
                        <td class="col-dare" style="text-align: right;">${dareStr}</td>
                        <td class="col-avere" style="text-align: right;">${avereStr}</td>
                        <td>${progBancaStr}</td>
                        <td style="text-align: center;">${nMovBancaStr}</td>
                    </tr>
                `;
            });

            // Calcola totali
            const totaleDare = datiMastrino.reduce((sum, row) => sum + (row.dare || 0), 0);
            const totaleAvere = datiMastrino.reduce((sum, row) => sum + (row.avere || 0), 0);

            html += `
                </tbody>
                <tfoot>
                    <tr class="totals-row">
                        <td colspan="5" style="text-align: right; font-weight: 700;">TOTALE:</td>
                        <td class="col-dare" style="text-align: right; font-weight: 700;"><span class="importo-dare">${formatImportoItaliano(totaleDare)}</span></td>
                        <td class="col-avere" style="text-align: right; font-weight: 700;"><span class="importo-avere">${formatImportoItaliano(totaleAvere)}</span></td>
                        <td colspan="2"></td>
                    </tr>
                </tfoot>
            `;
            table.innerHTML = html;
        }

        function popolaTabellaCommissioni(data) {
            const table = document.getElementById('table-commissioni');

            // Usa la tabella commissioniDaRegistrare invece del parametro data
            if (commissioniDaRegistrare.length === 0) {
                table.innerHTML = `<div class="empty-state"><p>Nessuna commissione da registrare</p></div>`;
                return;
            }

            let html = `
                <thead>
                    <tr>
                        <th style="width: 10%;">Prog Banca</th>
                        <th style="width: 10%;">Data</th>
                        <th style="width: 40%;">Descrizione</th>
                        <th style="width: 15%; text-align: right;">Commissione</th>
                        <th style="width: 25%; text-align: right; padding-right: 100px;">Importo Banca</th>
                    </tr>
                </thead>
                <tbody>
            `;

            commissioniDaRegistrare.forEach(c => {
                html += `
                    <tr>
                        <td>${c.prog_banca}</td>
                        <td>${formatData(c.data_banca)}</td>
                        <td>${c.descrizione || ''}</td>
                        <td style="text-align: right;"><span class="importo-uscita">${formatImportoItaliano(c.importo)}</span></td>
                        <td style="text-align: right; padding-right: 100px;"><span class="importo-uscita">${formatImportoItaliano(c.importo_banca)}</span></td>
                    </tr>
                `;
            });

            // Calcola totale commissioni
            const totaleCommissioni = commissioniDaRegistrare.reduce((sum, c) => sum + c.importo, 0);

            html += `
                </tbody>
                <tfoot>
                    <tr class="totals-row">
                        <td colspan="3" style="text-align: right; font-weight: 700;">TOTALE:</td>
                        <td style="text-align: right; font-weight: 700;"><span class="importo-uscita">${formatImportoItaliano(totaleCommissioni)}</span></td>
                        <td></td>
                    </tr>
                </tfoot>
            `;
            table.innerHTML = html;
        }

        function applyFilters() {
            // Leggi i filtri selezionati dai radio button
            const tipoFilter = document.querySelector('input[name="tipo-filter"]:checked')?.value || 'all';
            const statoFilter = document.querySelector('input[name="stato-filter"]:checked')?.value || 'all';
            
            filtriAttivi = { tipo: tipoFilter, stato: statoFilter };
            
            // Aggiorna stato visivo bottoni
            updateFiltersButtonState();
            
            // Riferimenti alle tabelle
            const tableEstratto = document.getElementById('table-estratto-conto');
            const tableMastrino = document.getElementById('table-mastrino');
            
            // GESTIONE VISIBILITÃ€ COLONNE - Estratto Conto
            if (tipoFilter === 'entrate-dare') {
                // Mostra solo Entrate, nascondi Uscite
                tableEstratto.classList.add('hide-column-uscite');
                tableEstratto.classList.remove('hide-column-entrate');
            } else if (tipoFilter === 'uscite-avere') {
                // Mostra solo Uscite, nascondi Entrate
                tableEstratto.classList.add('hide-column-entrate');
                tableEstratto.classList.remove('hide-column-uscite');
            } else {
                // Mostra entrambe
                tableEstratto.classList.remove('hide-column-uscite');
                tableEstratto.classList.remove('hide-column-entrate');
            }
            
            // GESTIONE VISIBILITÃ€ COLONNE - Mastrino
            if (tipoFilter === 'entrate-dare') {
                // Mostra solo Dare, nascondi Avere
                tableMastrino.classList.add('hide-column-avere');
                tableMastrino.classList.remove('hide-column-dare');
            } else if (tipoFilter === 'uscite-avere') {
                // Mostra solo Avere, nascondi Dare
                tableMastrino.classList.add('hide-column-dare');
                tableMastrino.classList.remove('hide-column-avere');
            } else {
                // Mostra entrambe
                tableMastrino.classList.remove('hide-column-dare');
                tableMastrino.classList.remove('hide-column-avere');
            }
            
            // Applica filtri a Estratto Conto (nasconde righe)
            const rowsEstratto = document.querySelectorAll('#table-estratto-conto tbody tr');
            rowsEstratto.forEach(row => {
                const rowTipo = row.dataset.tipo;
                const rowStato = row.dataset.stato;
                
                let show = true;
                
                // Filtro tipo
                if (tipoFilter === 'entrate-dare' && rowTipo !== 'entrata') show = false;
                if (tipoFilter === 'uscite-avere' && rowTipo !== 'uscita') show = false;
                
                // Filtro stato
                if (statoFilter === 'conciliati' && rowStato !== 'conciliato') show = false;
                if (statoFilter === 'non-conciliati' && rowStato !== 'non-conciliato') show = false;
                
                if (show) {
                    row.classList.remove('filter-hidden');
                } else {
                    row.classList.add('filter-hidden');
                }
            });
            
            // Applica filtri a Mastrino
            const rowsMastrino = document.querySelectorAll('#table-mastrino tbody tr');
            rowsMastrino.forEach(row => {
                const rowTipo = row.dataset.tipo;
                const rowStato = row.dataset.stato;
                
                let show = true;
                
                // Filtro tipo
                if (tipoFilter === 'entrate-dare' && rowTipo !== 'dare') show = false;
                if (tipoFilter === 'uscite-avere' && rowTipo !== 'avere') show = false;
                
                // Filtro stato
                if (statoFilter === 'conciliati' && rowStato !== 'conciliato') show = false;
                if (statoFilter === 'non-conciliati' && rowStato !== 'non-conciliato') show = false;
                
                if (show) {
                    row.classList.remove('filter-hidden');
                } else {
                    row.classList.add('filter-hidden');
                }
            });
            
            // Ricalcola i totali considerando solo le righe visibili
            ricalcolaTotaliFiltrati();
        }
        
        function ricalcolaTotaliFiltrati() {
            // ESTRATTO CONTO - Ricalcola totali
            const rowsEstrattoVisibili = document.querySelectorAll('#table-estratto-conto tbody tr:not(.filter-hidden)');
            let totaleUsciteFiltrate = 0;
            let totaleEntrateFiltrate = 0;
            
            rowsEstrattoVisibili.forEach(row => {
                const uscite = parseFloat(row.dataset.uscite) || 0;
                const entrate = parseFloat(row.dataset.entrate) || 0;
                totaleUsciteFiltrate += uscite;
                totaleEntrateFiltrate += entrate;
            });
            
            // Aggiorna footer estratto conto
            const footerEstrattoUscite = document.querySelector('#table-estratto-conto tfoot .col-uscite');
            const footerEstrattoEntrate = document.querySelector('#table-estratto-conto tfoot .col-entrate');
            if (footerEstrattoUscite) {
                footerEstrattoUscite.innerHTML = `<span class="importo-uscita">${formatImportoItaliano(totaleUsciteFiltrate)}</span>`;
            }
            if (footerEstrattoEntrate) {
                footerEstrattoEntrate.innerHTML = `<span class="importo-entrata">${formatImportoItaliano(totaleEntrateFiltrate)}</span>`;
            }
            
            // MASTRINO - Ricalcola totali
            const rowsMastrinoVisibili = document.querySelectorAll('#table-mastrino tbody tr:not(.filter-hidden)');
            let totaleDareFiltrato = 0;
            let totaleAvereFiltrato = 0;
            
            rowsMastrinoVisibili.forEach(row => {
                const dare = parseFloat(row.dataset.dare) || 0;
                const avere = parseFloat(row.dataset.avere) || 0;
                totaleDareFiltrato += dare;
                totaleAvereFiltrato += avere;
            });
            
            // Aggiorna footer mastrino
            const footerMastrinoDare = document.querySelector('#table-mastrino tfoot .col-dare');
            const footerMastrinoAvere = document.querySelector('#table-mastrino tfoot .col-avere');
            if (footerMastrinoDare) {
                footerMastrinoDare.innerHTML = `<span class="importo-dare">${formatImportoItaliano(totaleDareFiltrato)}</span>`;
            }
            if (footerMastrinoAvere) {
                footerMastrinoAvere.innerHTML = `<span class="importo-avere">${formatImportoItaliano(totaleAvereFiltrato)}</span>`;
            }
        }
        
        function updateFiltersButtonState() {
            const tipoFilter = document.querySelector('input[name="tipo-filter"]:checked')?.value || 'all';
            const statoFilter = document.querySelector('input[name="stato-filter"]:checked')?.value || 'all';
            
            const hasActiveFilters = (tipoFilter !== 'all' || statoFilter !== 'all');
            
            // Aggiorna bottone reset
            const btnReset = document.getElementById('btn-reset-filters');
            if (btnReset) {
                if (hasActiveFilters) {
                    btnReset.classList.add('active');
                    btnReset.title = 'Resetta filtri attivi';
                } else {
                    btnReset.classList.remove('active');
                    btnReset.title = 'Nessun filtro attivo';
                }
            }
            
            // Aggiorna bottone filtri
            const btnToggle = document.getElementById('filters-toggle');
            if (btnToggle) {
                if (hasActiveFilters) {
                    btnToggle.classList.add('has-filters');
                } else {
                    btnToggle.classList.remove('has-filters');
                }
            }
        }
        
        function toggleFilters() {
            const menu = document.getElementById('filters-menu');
            const toggle = document.getElementById('filters-toggle');
            menu.classList.toggle('show');
            toggle.classList.toggle('active');
        }
        
        function resetFilters() {
            // Reset radio buttons
            document.querySelectorAll('input[name="tipo-filter"]').forEach(input => {
                input.checked = (input.value === 'all');
            });
            document.querySelectorAll('input[name="stato-filter"]').forEach(input => {
                input.checked = (input.value === 'all');
            });
            
            // Applica filtri
            applyFilters();
            
            // Chiudi menu
            const menu = document.getElementById('filters-menu');
            const toggle = document.getElementById('filters-toggle');
            if (menu) menu.classList.remove('show');
            if (toggle) toggle.classList.remove('active');
        }
        
        // Chiudi menu filtri quando si clicca fuori
        document.addEventListener('click', function(e) {
            const filtersControls = document.getElementById('filters-controls');
            const menu = document.getElementById('filters-menu');
            const toggle = document.getElementById('filters-toggle');
            
            if (filtersControls && !filtersControls.contains(e.target) && menu && menu.classList.contains('show')) {
                menu.classList.remove('show');
                if (toggle) toggle.classList.remove('active');
            }
        });
        
        
        
        function popolaTabella(tableId, data, headers, fields) {
            const table = document.getElementById(tableId);
            
            if (data.length === 0) {
                table.innerHTML = `
                    <div class="empty-state">
                        <p>Nessun dato disponibile</p>
                    </div>
                `;
                return;
            }
            
            let html = '<thead><tr>';
            headers.forEach(h => html += `<th>${h}</th>`);
            html += '</tr></thead><tbody>';
            
            // Calcola totale per tabelle con importi
            let totale = 0;
            let hasImporto = false;
            let importoFieldIndex = -1;
            
            // Identifica se c'Ã¨ un campo importo e quale
            fields.forEach((f, idx) => {
                if (f === 'entrate' || f === 'uscite' || f === 'dare' || f === 'avere') {
                    hasImporto = true;
                    importoFieldIndex = idx;
                }
            });
            
            data.forEach(row => {
                html += '<tr>';
                fields.forEach(f => {
                    let val = row[f];
                    if (f === 'data' || f === 'data_doc') {
                        val = formatData(val);
                    } else if (f === 'data_str_originale' || f === 'data_reg_str_originale' || f === 'valuta_str_originale') {
                        val = val || '';
                    } else if (f === 'num_movimenti_mastrino' || f === 'num_movimenti_banca') {
                        val = val || '';
                    } else if (typeof val === 'number') {
                        if (f === 'entrate' || f === 'uscite' || f === 'dare' || f === 'avere') {
                            totale += val;
                        }
                        val = 'â‚¬ ' + formatImportoItaliano(val);
                    } else if (!val) {
                        val = '';
                    }
                    html += `<td>${val}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody>';
            
            // Aggiungi footer con totale se ha importi
            if (hasImporto && totale > 0) {
                html += '<tfoot><tr style="font-weight: bold; background: #f0f2ff;">';
                fields.forEach((f, idx) => {
                    if (idx === importoFieldIndex) {
                        html += `<td>TOTALE: â‚¬ ${formatImportoItaliano(totale)}</td>`;
                    } else if (idx === 0) {
                        html += `<td>TOTALE</td>`;
                    } else {
                        html += '<td></td>';
                    }
                });
                html += '</tr></tfoot>';
            }
            
            table.innerHTML = html;
        }
        
        // === EXPORT EXCEL ===
        
        function generaExcel() {
            console.log('ðŸ“¥ Generazione file Excel...');
            
            const wb = XLSX.utils.book_new();
            
            const entrate = risultati.entrate.filter(m => m.entrate);
            const uscite = risultati.entrate.filter(m => m.uscite);
            
            const entrateConc = entrate.filter(e => e.conciliato).length;
            const usciteConc = uscite.filter(u => u.conciliato).length;
            const commMast = uscite.reduce((s, u) => s + (u.commissione_mastrino || 0), 0);
            const commCalc = commissioniDaRegistrare.reduce((s, c) => s + c.importo, 0);
            
            // FOGLIO 1: Riepilogo (manteniamo struttura attuale)
            const riepilogo = [
                ['RIEPILOGO CONCILIAZIONE BANCARIA SESPRESSO v4'],
                ['Anno di riferimento', annoRiferimento],
                [],
                ['Descrizione', 'QuantitÃ ', 'Importo'],
                ['MOVIMENTI BANCARI', '', ''],
                ['Entrate totali', entrate.length, entrate.reduce((s,e) => s + (e.entrate||0), 0)],
                ['  - Conciliate', entrateConc, entrate.filter(e=>e.conciliato).reduce((s,e) => s + (e.entrate||0), 0)],
                ['  - NON conciliate', entrate.length - entrateConc, entrate.filter(e=>!e.conciliato).reduce((s,e) => s + (e.entrate||0), 0)],
                [''],
                ['Uscite totali', uscite.length, uscite.reduce((s,u) => s + (u.uscite||0), 0)],
                ['  - Conciliate', usciteConc, uscite.filter(u=>u.conciliato).reduce((s,u) => s + (u.uscite||0), 0)],
                ['  - NON conciliate', uscite.length - usciteConc, uscite.filter(u=>!u.conciliato).reduce((s,u) => s + (u.uscite||0), 0)],
                [''],
                ['MOVIMENTI MASTRINO', '', ''],
                ['DARE totali', risultati.dare.length, risultati.dare.reduce((s,d) => s + (d.dare||0), 0)],
                ['  - Conciliati', risultati.dare.filter(d=>d.conciliato).length, risultati.dare.filter(d=>d.conciliato).reduce((s,d) => s + (d.dare||0), 0)],
                ['  - NON conciliati', risultati.dare.filter(d=>!d.conciliato).length, risultati.dare.filter(d=>!d.conciliato).reduce((s,d) => s + (d.dare||0), 0)],
                [''],
                ['AVERE totali', risultati.avere.length, risultati.avere.reduce((s,a) => s + (a.avere||0), 0)],
                ['  - Conciliati', risultati.avere.filter(a=>a.conciliato).length, risultati.avere.filter(a=>a.conciliato).reduce((s,a) => s + (a.avere||0), 0)],
                ['  - NON conciliati', risultati.avere.filter(a=>!a.conciliato).length, risultati.avere.filter(a=>!a.conciliato).reduce((s,a) => s + (a.avere||0), 0)],
                [''],
                ['COMMISSIONI', '', ''],
                ['Commissioni nel mastrino', uscite.filter(u => u.commissione_mastrino > 0).length, commMast],
                ['Commissioni da registrare', commissioniDaRegistrare.length, commCalc],
                ['Totale commissioni', '', commMast + commCalc]
            ];
            
            const wsRiep = XLSX.utils.aoa_to_sheet(riepilogo);
            XLSX.utils.book_append_sheet(wb, wsRiep, 'Riepilogo');
            
            // FOGLIO 2: Estratto Conto (tutte le righe con colonne dell'interfaccia)
            const estrattoData = [...entrate, ...uscite].sort((a, b) => {
                const progA = parseInt(a.prog.replace(/[^0-9]/g, '')) || 0;
                const progB = parseInt(b.prog.replace(/[^0-9]/g, '')) || 0;
                return progA - progB;
            }).map(row => ({
                'Stato': row.conciliato ? 'Conciliato' : 'Non Conciliato',
                'Prog Banca': row.prog,
                'Data': formatData(row.data),
                'Descrizione': row.descrizione || '',
                'Uscite': row.uscite || '',
                'Entrate': row.entrate || '',
                'Prog Mastrino': row.mastrino_progs || '',
                'Commissioni da registrare': row.commissione_calcolata || '',
                'N.Mov Mastrino': row.num_movimenti_mastrino || ''
            }));
            
            if (estrattoData.length > 0) {
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(estrattoData), 'Estratto Conto');
            }
            
            // FOGLIO 3: Mastrino (tutte le righe con colonne dell'interfaccia)
            const mastrinoData = [...risultati.dare, ...risultati.avere].sort((a, b) => {
                const progA = parseInt(a.prog.replace(/[^0-9]/g, '')) || 0;
                const progB = parseInt(b.prog.replace(/[^0-9]/g, '')) || 0;
                return progA - progB;
            }).map(row => ({
                'Stato': row.conciliato ? 'Conciliato' : 'Non Conciliato',
                'Prog Mastrino': row.prog,
                'Data Reg': formatData(row.data),
                'Num Doc': row.num_doc || '',
                'Descrizione': row.descrizione || '',
                'DARE': row.dare || '',
                'AVERE': row.avere || '',
                'Prog Banca': row.banca_prog || '',
                'N.Mov Banca': row.num_movimenti_banca || ''
            }));
            
            if (mastrinoData.length > 0) {
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mastrinoData), 'Mastrino');
            }
            
            // FOGLIO 4: Commissioni da Registrare (dalla tabella dedicata)
            if (commissioniDaRegistrare.length > 0) {
                const data = commissioniDaRegistrare.map(c => ({
                    'Prog Banca': c.prog_banca,
                    'Data': formatData(c.data_banca),
                    'Descrizione': c.descrizione,
                    'Commissione': c.importo,
                    'Importo Banca': c.importo_banca
                }));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), 'Commissioni da Registrare');
            }
            
            XLSX.writeFile(wb, `Conciliazione_Bancaria_SESPRESSO_${annoRiferimento || 'anno'}_v4.xlsx`);
            console.log('âœ… File Excel generato');
        }
        
        // === EVENT LISTENERS ===
        
        setupDropzone('dropzone-estratto-sidebar', 'file-estratto-sidebar', 'info-estratto-sidebar', 'estratto');
        setupDropzone('dropzone-mastrino-sidebar', 'file-mastrino-sidebar', 'info-mastrino-sidebar', 'mastrino');
        
        // Tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
                
                // Mostra/nascondi filtri: visibili solo per estratto-conto e mastrino
                const filtersControls = document.getElementById('filters-controls');
                const tabName = tab.dataset.tab;
                if (filtersControls) {
                    if (tabName === 'estratto-conto' || tabName === 'mastrino') {
                        filtersControls.classList.remove('hidden');
                    } else {
                        filtersControls.classList.add('hidden');
                        // Chiudi menu se aperto
                        const filtersMenu = document.getElementById('filters-menu');
                        const filtersToggle = document.getElementById('filters-toggle');
                        if (filtersMenu) filtersMenu.classList.remove('show');
                        if (filtersToggle) filtersToggle.classList.remove('active');
                    }
                }
            });
        });
        
        // === GESTIONE DROPDOWN E PARAMETRI ===
        
        let parametriIniziali = null;
        let hasConciliatoUnaVolta = false;
        let periodiSalvati = [];
        
        function toggleDropdown(type) {
            const content = document.getElementById(`dropdown-${type}-content`);
            content.classList.toggle('show');
            
            // Chiudi altri dropdown
            document.querySelectorAll('.dropdown-content').forEach(d => {
                if (d.id !== `dropdown-${type}-content`) {
                    d.classList.remove('show');
                }
            });
        }
        
        // Chiudi dropdown quando si clicca fuori
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.custom-dropdown')) {
                document.querySelectorAll('.dropdown-content').forEach(d => d.classList.remove('show'));
            }
        });
        
        function updateRangeValue(type, value) {
            document.getElementById(`val-${type}`).textContent = value;
        }
        
        async function avviaConciliazioneAutomatica() {
            // Reset filtri prima di conciliare
            resetFilters();
            
            // Usa i periodi salvati se Ã¨ la seconda+ conciliazione, altrimenti prendi quelli attuali
            const periodi = hasConciliatoUnaVolta ? periodiSalvati : getPeriodi();
            
            if (periodi.length === 0) return;
            
            const config = getParametriConfig();
            COMMISSIONI_AMMESSE = config.commissioni;
            
            const inizioOverlay = Date.now();
            mostraLoading();
            
            setTimeout(() => {
                try {
                    risultati = concilia(
                        [...estrattoConto], 
                        [...mastrino], 
                        config,
                        periodi,
                        (progress) => {
                            // Progress bar rimossa, usiamo loading overlay
                        },
                        hasConciliatoUnaVolta
                    );
                    
                    mostraRisultati(risultati);
                    
                    if (!hasConciliatoUnaVolta) {
                        showAlert('âœ… Prima conciliazione completata!', 'success');
                        salvaParametriIniziali();
                        // Mostra config FAB
                        mostraConfigFab();
                    } else {
                        showAlert('âœ… Conciliazione aggiornata!', 'success');
                    }
                    
                    // DELAY MINIMO GARANTITO: L'overlay rimane visibile almeno 800ms
                    const tempoTrascorso = Date.now() - inizioOverlay;
                    const delayMinimo = 800; // millisecondi
                    const ritardoNecessario = Math.max(0, delayMinimo - tempoTrascorso);
                    
                    setTimeout(() => {
                        nascondiLoading();
                    }, ritardoNecessario);
                    
                } catch (error) {
                    console.error('âŒ Errore conciliazione:', error);
                    showAlert('âŒ Errore: ' + error.message, 'error');
                    nascondiLoading();
                }
            }, 100);
        }
        
        function updatePeriodoText() {
            const checkboxes = document.querySelectorAll('#dropdown-periodo-content input[type="checkbox"]:checked');
            const selected = Array.from(checkboxes).map(cb => cb.value);
            const text = selected.length > 0 ? selected.join(', ') : 'Seleziona...';
            document.getElementById('periodo-text').textContent = text;
            
            // Chiudi dropdown e avvia conciliazione automatica se Ã¨ la prima volta
            if (selected.length > 0 && !hasConciliatoUnaVolta) {
                setTimeout(() => {
                    document.querySelectorAll('.dropdown-content').forEach(d => d.classList.remove('show'));
                    avviaConciliazioneAutomatica();
                }, 300);
            } else {
                onConfigChange();
            }
        }
        
        function updateCommissioniText() {
            const checkboxes = document.querySelectorAll('#dropdown-commissioni-content input[type="checkbox"]:checked');
            const selected = Array.from(checkboxes).map(cb => parseFloat(cb.value)).sort((a,b) => a-b);
            const text = selected.length > 0 ? selected.join(', ') : 'Nessuna';
            document.getElementById('commissioni-text').textContent = text;
            onConfigChange();
        }
        
        function showAddCommission() {
            document.getElementById('add-commission-input').classList.toggle('show');
            event.stopPropagation();
        }
        
        function addCommission() {
            const input = document.getElementById('new-commission-value');
            const value = parseFloat(input.value);
            
            if (!value || value <= 0) {
                alert('Inserisci un valore valido maggiore di 0');
                return;
            }
            
            // Controlla se esiste giÃ 
            const exists = document.querySelector(`#dropdown-commissioni-content input[value="${value}"]`);
            if (exists) {
                alert('Commissione giÃ  presente');
                return;
            }
            
            // Crea nuovo item
            const container = document.getElementById('dropdown-commissioni-content');
            const newItem = document.createElement('div');
            newItem.className = 'dropdown-item';
            newItem.innerHTML = `
                <input type="checkbox" id="comm-${value.toString().replace('.', '')}" value="${value}" checked onchange="updateCommissioniText()">
                <label for="comm-${value.toString().replace('.', '')}">${value.toFixed(2)}</label>
            `;
            container.appendChild(newItem);
            
            input.value = '';
            document.getElementById('add-commission-input').classList.remove('show');
            updateCommissioniText();
        }
        
        function getCommissioniAmmesse() {
            return Array.from(document.querySelectorAll('#commission-list input:checked')).map(c => {
                const text = c.nextElementSibling.textContent.replace('â‚¬ ', '');
                return parseFloat(text);
            });
        }
        
        function getPeriodi() {
            return Array.from(document.querySelectorAll('.tag.selected')).map(t => t.dataset.value);
        }
        
        function onConfigChange() {
            // Non piÃ¹ necessario - gestito nella sidebar
        }
        
        function getParametriConfig() {
            return {
                maxMovimenti: sliderValues.movimenti,
                tolleranzaImporto: sliderValues.importo,
                tolleranzaGiorni: sliderValues.giorni,
                periodi: getPeriodi(),
                commissioni: getCommissioniAmmesse()
            };
        }
        
        function salvaParametriIniziali() {
            parametriIniziali = getParametriConfig();
            periodiSalvati = getPeriodi(); // Salva i periodi della prima conciliazione
            hasConciliatoUnaVolta = true;
            console.log('ðŸ“Œ Periodi salvati:', periodiSalvati);
        }
        
        console.log('âœ… SESPRESSO Conciliator v4 pronto');
    </script>
</body>
</html>